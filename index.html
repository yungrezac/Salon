<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Конструктор Салона Красоты</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc;
            --secondary-bg-color: #ffffff;
            --text-color: #334155;
            --hint-color: #94a3b8;
            --border-color: #e2e8f0;
            --button-color: #c08497;
            --button-text-color: #ffffff;
            --header-bg-color: #ffffff;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .main-container { padding-bottom: 80px; }
        .btn-primary { background-color: var(--button-color); color: var(--button-text-color); }
        .btn { font-weight: 600; border-radius: 0.75rem; padding: 0.65rem 1.5rem; transition: all 0.2s; text-align: center; }
        .btn:hover { opacity: 0.9; transform: scale(1.02); }
        .card { background-color: var(--secondary-bg-color); border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07); }
        .screen { display: none; animation: fadeIn 0.3s ease-out; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.3s; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--button-color); animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .admin-input { @apply w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-pink-500 focus:border-pink-500; }
        .admin-card { @apply bg-white p-4 sm:p-6 rounded-lg shadow-md mb-6; }
        
        .time-slot { cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s; }
        .time-slot.selected { background-color: var(--button-color); color: var(--button-text-color); border-color: var(--button-color); transform: scale(1.05); }
        .time-slot:not(.disabled):hover { background-color: #fde6ea; border-color: #fde6ea; }
        .time-slot.disabled { background-color: #f1f5f9; color: var(--hint-color); cursor: not-allowed; }
        
        .nav-item { color: var(--hint-color); transition: all 0.2s; }
        .nav-item.active { color: var(--button-color); background-color: #fde6ea; }
        .nav-item.active svg { color: var(--button-color); }

        #toast-container { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .toast { background-color: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; animation: toast-in 0.3s ease, toast-out 0.3s ease 2.7s forwards; }
        @keyframes toast-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }

        /* Skeleton Loader */
        .skeleton { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="antialiased text-sm">

    <div id="loader"><div class="spinner"></div></div>
    <div id="toast-container"></div>

    <div id="constructor-wrapper">
        <div id="setup-screen" class="screen p-6 min-h-screen flex-col justify-center items-center">
             <div class="w-full max-w-md text-center">
                <h1 class="text-2xl font-bold mb-2">Создайте свой салон</h1>
                <p class="text-slate-500 mb-8">Заполните данные, чтобы получить ссылки на приложение и панель управления.</p>
                <div class="card p-6 text-left !mb-6">
                    <div class="mb-4"><label class="block font-semibold mb-2">Название салона</label><input type="text" id="salon-name-input" placeholder="Например, Beauty Haven" class="w-full p-3 border rounded-lg"></div>
                    <div class="mb-4"><label class="block font-semibold mb-2">URL логотипа</label><input type="url" id="logo-url-input" placeholder="https://example.com/logo.png" class="w-full p-3 border rounded-lg"></div>
                    <div class="mb-6"><label class="block font-semibold mb-2">Пароль для админ-панели</label><input type="password" id="salon-admin-password" placeholder="••••••••" class="w-full p-3 border rounded-lg"></div>
                    <button id="generate-link-btn" class="btn btn-primary w-full py-3">Создать салон</button>
                </div>
                <div id="link-result" class="text-left" style="display: none;">
                    <div class="card p-4 space-y-4">
                        <div>
                            <label class="block font-semibold mb-2 text-sm">Ссылка для ваших клиентов:</label>
                            <div class="flex space-x-2"><input type="text" id="generated-client-link" readonly class="w-full p-2 border rounded-lg bg-slate-100 text-xs"><button onclick="App.copyLink('generated-client-link')" class="btn btn-primary text-sm px-4">Копировать</button></div>
                        </div>
                        <div>
                            <label class="block font-semibold mb-2 text-sm text-red-600">Ваша секретная ссылка для админ-панели:</label>
                            <div class="flex space-x-2"><input type="text" id="generated-admin-link" readonly class="w-full p-2 border rounded-lg bg-slate-100 text-xs"><button onclick="App.copyLink('generated-admin-link')" class="btn btn-primary text-sm px-4">Копировать</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="client-app-wrapper" style="display: none;">
        <div class="main-container min-h-screen">
            
            <header id="client-header" class="flex items-center p-4 pt-6 bg-white shadow-sm sticky top-0 z-20" style="background-color: var(--header-bg-color);">
                <img id="salon-logo-header" src="" alt="Logo" class="w-10 h-10 rounded-full object-cover">
                <h1 id="salon-name-header" class="text-xl font-bold text-slate-800 ml-3" style="color: var(--text-color);"></h1>
            </header>
            
            <div id="home-screen" class="screen">
                <div id="portfolio-posts" class="space-y-1 bg-slate-100 pt-1" style="background-color: var(--bg-color);"></div>
            </div>

            <div id="post-view-screen" class="screen"></div>
            
            <div id="services-screen" class="screen p-4">
                <h1 class="text-xl font-bold mb-5">Выберите услугу</h1>
                <div id="services-list" class="space-y-3"></div>
            </div>

            <div id="specialist-selection-screen" class="screen p-4">
                <h1 class="text-xl font-bold mb-5">Выберите мастера</h1>
                <div id="specialists-list" class="space-y-3"></div>
            </div>
            
            <div id="booking-screen" class="screen p-4">
                <h1 class="text-xl font-bold mb-5">Выберите дату и время</h1>
                <div class="card p-4 mb-4">
                    <h2 class="font-semibold mb-1 text-base" id="selected-service-title"></h2>
                    <p class="text-sm text-slate-500" id="selected-specialist-subtitle" style="color: var(--hint-color);"></p>
                </div>
                <div class="card p-4">
                    <input type="date" id="date-picker" class="w-full p-2 border rounded-lg mb-4">
                    <h2 class="font-semibold mb-3">Доступное время:</h2>
                    <div id="time-slots-container" class="grid grid-cols-3 gap-3 text-center text-xs"></div>
                </div>
            </div>
            
            <div id="my-appointments-screen" class="screen p-4">
                <h1 class="text-xl font-bold mb-5">Мои записи</h1>
                <div id="appointments-list"></div>
            </div>
            
            <div id="profile-screen" class="screen p-4">
                <h1 class="text-xl font-bold mb-5">Профиль</h1>
                <div class="card p-4 flex items-center">
                    <img id="profile-avatar" src="" alt="Avatar" class="w-16 h-16 rounded-full mr-4">
                    <div>
                        <h2 id="profile-name" class="font-bold text-lg"></h2>
                        <p class="text-slate-500" style="color: var(--hint-color);">Данные из Telegram</p>
                    </div>
                </div>
            </div>

            <div id="success-screen" class="screen text-center p-8 flex flex-col justify-center items-center min-h-[80vh]">
                <div>
                    <div class="mb-5"><svg class="w-16 h-16 text-green-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <h1 class="text-xl font-bold mb-2">Вы успешно записаны!</h1>
                    <p class="text-slate-600 mb-6" id="success-details" style="color: var(--hint-color);"></p>
                    <button onclick="App.ui.showScreen('my-appointments-screen')" class="btn btn-primary">Посмотреть мои записи</button>
                </div>
            </div>
        </div>

        <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)] flex justify-around p-2 z-30" style="background-color: var(--secondary-bg-color);">
            <button data-screen="home-screen" class="nav-item flex flex-col items-center justify-center w-full text-xs p-1 rounded-lg"><svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg><span>Главная</span></button>
            <button data-screen="services-screen" class="nav-item flex flex-col items-center justify-center w-full text-xs p-1 rounded-lg"><svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.75h16.5m-16.5 4.5h16.5m-16.5 4.5h16.5M6.75 21v-5.625a3.375 3.375 0 013.375-3.375h3.75a3.375 3.375 0 013.375 3.375V21" /></svg><span>Запись</span></button>
            <button data-screen="my-appointments-screen" class="nav-item flex flex-col items-center justify-center w-full text-xs p-1 rounded-lg"><svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M12 15.75h.008v.008H12v-.008z" /></svg><span>Мои записи</span></button>
            <button data-screen="profile-screen" class="nav-item flex flex-col items-center justify-center w-full text-xs p-1 rounded-lg"><svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg><span>Профиль</span></button>
        </nav>
    </div>

    <div id="admin-mode-wrapper" style="display: none;" class="p-4 md:p-8 bg-slate-50 min-h-screen">
        <div id="admin-login-screen" class="max-w-md mx-auto">
            <div class="admin-card mt-10">
                <h1 class="text-2xl font-bold mb-4">Вход в панель управления</h1>
                <p class="mb-4 text-gray-600">Введите пароль от вашего салона.</p>
                <input type="password" id="password-input" class="admin-input" placeholder="••••••••">
                <button id="login-btn" class="btn btn-primary w-full mt-4 bg-pink-600 hover:bg-pink-700">Войти</button>
                <p id="login-error" class="text-red-500 mt-2 text-sm text-center"></p>
            </div>
        </div>

        <div id="admin-panel" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl sm:text-3xl font-bold">Панель "<span id="admin-salon-name"></span>"</h1>
                <button id="logout-btn" class="text-sm text-slate-500 hover:text-slate-800">Выйти</button>
            </div>
            
            <div class="mb-6 border-b border-slate-200">
                <nav class="-mb-px flex space-x-6" id="admin-nav">
                    <button data-panel="appointments" class="admin-nav-item whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Записи</button>
                    <button data-panel="services" class="admin-nav-item whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Услуги</button>
                    <button data-panel="specialists" class="admin-nav-item whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Мастера</button>
                    <button data-panel="portfolio" class="admin-nav-item whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Портфолио</button>
                    <button data-panel="theme" class="admin-nav-item whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Тема</button>
                </nav>
            </div>
            <style>
                .admin-nav-item { border-color: transparent; color: #64748b; }
                .admin-nav-item.active { border-color: #c08497; color: #c08497; }
            </style>
            
            <div id="admin-panels-container">
                <div id="admin-panel-appointments" class="admin-panel-content"></div>
                <div id="admin-panel-services" class="admin-panel-content"></div>
                <div id="admin-panel-specialists" class="admin-panel-content"></div>
                <div id="admin-panel-portfolio" class="admin-panel-content"></div>
                <div id="admin-panel-theme" class="admin-panel-content"></div>
            </div>
        </div>
    </div>


<script>
// ==================================================================
// ==================================================================
//                      BEAUTY SALON MINI APP SCRIPT
// ==================================================================
// ==================================================================

const App = {

    // ------------------------------------------------------------------
    // Properties
    // ------------------------------------------------------------------
    tg: window.Telegram.WebApp,
    supabase: null,
    
    config: {
        // IMPORTANT: For a real application, enable Row Level Security (RLS) in your Supabase project.
        // This 'anon' key is public and safe to expose as long as RLS is properly configured.
        supabaseUrl: 'https://iwvglucrgnwetczrzwqk.supabase.co',
        supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3dmdsdWNyZ253ZXRjenJ6d3FrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzY3NDgsImV4cCI6MjA3MDk1Mjc0OH0.Cn8YUKAlGyQKpZkXUxSHE9gQwsn0BFtH9GcaSJSpEiQ',
        workingHours: { start: 10, end: 19, slotDuration: 60 }, // in minutes
    },

    state: {
        salonId: null,
        salonConfig: {},
        currentUser: {},
        services: [],
        specialists: [],
        portfolio: [],
        userAppointments: [],
        allAppointments: [],
        bookingState: {},
        screenHistory: ['home-screen'],
        currentAdminPanel: 'appointments'
    },

    elements: {
        loader: null,
        toastContainer: null,
        // Add more cached elements here as needed
    },

    // ------------------------------------------------------------------
    // Initializer
    // ------------------------------------------------------------------
    init() {
        console.log("App Initializing...");
        this.supabase = supabase.createClient(this.config.supabaseUrl, this.config.supabaseKey);
        this.elements.loader = document.getElementById('loader');
        this.elements.toastContainer = document.getElementById('toast-container');
        
        this.tg.ready();
        this.tg.expand();
        
        this.router();
    },

    // ------------------------------------------------------------------
    // Core Utilities
    // ------------------------------------------------------------------
    async router() {
        this.utils.showLoader();
        try {
            const params = new URLSearchParams(this.tg.initDataUnsafe?.start_param ? `?${this.tg.initDataUnsafe.start_param}` : window.location.hash.substring(1));
            this.state.salonId = params.get('salonId');
            const mode = params.get('mode');

            if (mode === 'admin' && this.state.salonId) {
                this.initAdmin();
            } else if (this.state.salonId) {
                await this.initClientApp();
            } else {
                this.initConstructor();
            }
        } catch (e) {
            console.error("Router failed:", e);
            alert("Произошла критическая ошибка при запуске приложения.");
        } finally {
            this.utils.hideLoader();
        }
    },

    utils: {
        showLoader() { App.elements.loader.style.display = 'flex'; },
        hideLoader() { 
            App.elements.loader.style.opacity = 0;
            setTimeout(() => App.elements.loader.style.display = 'none', 300);
        },
        showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            App.elements.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        },
        getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        },
        formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
        }
    },

    copyLink(elementId) {
        const linkInput = document.getElementById(elementId);
        linkInput.select();
        document.execCommand('copy');
        this.utils.showToast('Ссылка скопирована!');
    },

    // ------------------------------------------------------------------
    // Constructor Mode
    // ------------------------------------------------------------------
    initConstructor() {
        document.getElementById('constructor-wrapper').style.display = 'block';
        document.getElementById('setup-screen').classList.add('active', 'flex');
        document.getElementById('generate-link-btn').onclick = () => this.handleGenerateLink();
    },

    async handleGenerateLink() {
        const name = document.getElementById('salon-name-input').value.trim();
        const logo = document.getElementById('logo-url-input').value.trim();
        const password = document.getElementById('salon-admin-password').value.trim();
        if (!name || !logo || !password) {
            this.utils.showToast('Пожалуйста, заполните все поля.');
            return;
        }

        this.utils.showLoader();
        try {
            const { data: salonData, error } = await this.supabase
                .from('salons')
                .insert([{ name, logo_url: logo, admin_password: password }])
                .select()
                .single();
            if (error) throw error;
            
            await this.supabase.from('themes').insert([{ salon_id: salonData.id }]);

            const baseUrl = `https://t.me/${this.tg.initDataUnsafe.user.username}/<YOUR_APP_NAME>`; // Replace <YOUR_APP_NAME>
            document.getElementById('generated-client-link').value = `${baseUrl}?startapp=salonId=${salonData.id}`;
            document.getElementById('generated-admin-link').value = `${baseUrl}?startapp=salonId=${salonData.id}-mode=admin`;
            document.getElementById('link-result').style.display = 'block';

        } catch (error) {
            console.error("Salon creation failed:", error);
            this.utils.showToast('Ошибка создания салона: ' + error.message);
        } finally {
            this.utils.hideLoader();
        }
    },
    
    // ------------------------------------------------------------------
    // Client App Mode
    // ------------------------------------------------------------------
    async initClientApp() {
        document.getElementById('client-app-wrapper').style.display = 'block';
        this.client.displayUserData();
        
        const { data, error } = await this.supabase.from('salons').select(`*, themes(*)`).eq('id', this.state.salonId).single();
        if (error || !data) {
            this.utils.showToast('Салон не найден. Открываю конструктор.');
            setTimeout(() => this.initConstructor(), 2000);
            return;
        }
        
        this.state.salonConfig = data;
        this.ui.applyTheme(data.themes[0]);
        await this.client.upsertUser();
        this.client.setupEventListeners();
        
        await this.client.loadData();
        this.client.renderAll();
        
        this.ui.showScreen('home-screen');
    },

    client: {
        displayUserData() {
            const user = App.tg.initDataUnsafe?.user;
            App.state.currentUser = user ? user : { id: 123456789, first_name: 'Тест', username: 'testuser' };
            const userInitial = (App.state.currentUser.first_name || 'U').charAt(0);
            document.getElementById('profile-name').textContent = App.state.currentUser.first_name || 'Пользователь';
            document.getElementById('profile-avatar').src = `https://placehold.co/64x64/fde6ea/c08497?text=${userInitial}`;
        },

        async upsertUser() {
            const { id, first_name } = App.state.currentUser;
            if (!id) return;
            await App.supabase.from('users').upsert({ telegram_id: id, first_name }, { onConflict: 'telegram_id' });
        },

        setupEventListeners() {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.onclick = () => App.ui.showScreen(btn.dataset.screen);
            });
            App.tg.MainButton.setText('Подтвердить запись').onClick(App.client.handleBookingConfirm);
            App.tg.BackButton.onClick(() => App.ui.goBack());
            
            const datePicker = document.getElementById('date-picker');
            datePicker.min = App.utils.getTodayDateString();
            datePicker.onchange = e => {
                App.state.bookingState.date = e.target.value;
                App.state.bookingState.time = null;
                App.ui.renderTimeSlots();
            };
        },

        async loadData() {
            App.ui.renderSkeletons();
            const { salonId, currentUser } = App.state;
            const [servicesRes, specialistsRes, postsRes, appointmentsRes] = await Promise.all([
                App.supabase.from('services').select('*').eq('salon_id', salonId),
                App.supabase.from('specialists').select('*').eq('salon_id', salonId),
                App.supabase.from('portfolio_posts').select('*, comments(*, users(first_name))').eq('salon_id', salonId).order('created_at', { ascending: false }),
                App.supabase.from('appointments').select('*, services(*), specialists(*)').eq('user_telegram_id', currentUser.id).eq('salon_id', salonId).order('date').order('time')
            ]);

            App.state.services = servicesRes.data || [];
            App.state.specialists = specialistsRes.data || [];
            App.state.portfolio = postsRes.data || [];
            App.state.userAppointments = (appointmentsRes.data || []).map(a => ({ ...a, service: a.services, specialist: a.specialists }));
        },

        renderAll() {
            document.getElementById('salon-name-header').textContent = App.state.salonConfig.name;
            document.getElementById('salon-logo-header').src = App.state.salonConfig.logo_url;
            App.ui.renderServices();
            App.ui.renderAppointments();
            App.ui.renderPortfolio();
        },

        handleServiceSelect(service) {
            App.state.bookingState = { service };
            App.ui.renderSpecialists();
            App.ui.showScreen('specialist-selection-screen');
        },
        
        handleSpecialistSelect(specialist) {
            App.state.bookingState.specialist = specialist;
            const service = App.state.bookingState.service;
            document.getElementById('selected-service-title').textContent = service.name;
            document.getElementById('selected-specialist-subtitle').textContent = `Мастер: ${specialist.name}`;

            const datePicker = document.getElementById('date-picker');
            datePicker.value = App.utils.getTodayDateString();
            App.state.bookingState.date = datePicker.value;
            
            App.ui.renderTimeSlots();
            App.ui.showScreen('booking-screen');
        },
        
        handleTimeSelect(el, time) {
            if (el.classList.contains('disabled')) return;
            document.querySelectorAll('#time-slots-container .time-slot').forEach(s => s.classList.remove('selected'));
            el.classList.add('selected');
            App.state.bookingState.time = time;
            App.client.updateConfirmButtonState();
        },

        updateConfirmButtonState() {
            const { service, specialist, date, time } = App.state.bookingState;
            const isActive = !!(service && specialist && date && time);
            App.tg.MainButton.setParams({ is_visible: true, is_active: isActive });
        },

        async handleBookingConfirm() {
            if (!App.tg.MainButton.isActive) return;
            App.utils.showLoader();
            const { service, specialist, date, time } = App.state.bookingState;
            try {
                const { error } = await App.supabase.from('appointments').insert([{
                    salon_id: App.state.salonId,
                    user_telegram_id: App.state.currentUser.id,
                    service_id: service.id,
                    specialist_id: specialist.id,
                    date: date,
                    time: time
                }]);
                if (error) throw error;
                
                document.getElementById('success-details').textContent = `Ждем вас ${App.utils.formatDate(date)} в ${time} на услугу "${service.name}".`;
                App.ui.showScreen('success-screen');
                await App.client.loadData();
                App.ui.renderAppointments();

            } catch (error) {
                console.error("Booking failed:", error);
                App.utils.showToast('Ошибка записи: ' + error.message);
            } finally {
                App.utils.hideLoader();
            }
        },

        async handleAppointmentCancel(appointmentId) {
            if (!confirm('Вы уверены, что хотите отменить эту запись?')) return;
            App.utils.showLoader();
            try {
                const { error } = await App.supabase.from('appointments').delete().eq('id', appointmentId);
                if (error) throw error;
                App.utils.showToast('Запись успешно отменена');
                await App.client.loadData();
                App.ui.renderAppointments();
            } catch (error) {
                console.error("Cancellation failed:", error);
                App.utils.showToast('Ошибка отмены: ' + error.message);
            } finally {
                App.utils.hideLoader();
            }
        },
        
        async handlePostComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const text = input.value.trim();
            if (!text) return;
            
            App.utils.showLoader();
            try {
                const { error } = await App.supabase.from('comments').insert({
                    post_id: postId,
                    user_telegram_id: App.state.currentUser.id,
                    text: text
                });
                if (error) throw error;
                input.value = '';
                // Reload post data to show the new comment
                const { data: postData, error: postError } = await App.supabase.from('portfolio_posts')
                    .select('*, comments(*, users(first_name))')
                    .eq('id', postId)
                    .single();
                if (postError) throw postError;

                App.ui.renderPostDetail(postData);
            } catch (error) {
                console.error("Comment failed:", error);
                App.utils.showToast('Не удалось отправить комментарий.');
            } finally {
                App.utils.hideLoader();
            }
        }
    },

    ui: {
        applyTheme(theme) {
            const root = document.documentElement;
            if (!theme) return;
            const updateVar = (name, value, fallback) => root.style.setProperty(name, value || fallback);
            updateVar('--bg-color', theme.bg_color, '#f8fafc');
            updateVar('--text-color', theme.text_color, '#334155');
            updateVar('--button-color', theme.button_color, '#c08497');
            updateVar('--button-text-color', theme.button_text_color, '#ffffff');
            updateVar('--secondary-bg-color', theme.secondary_bg_color, '#ffffff');
        },

        showScreen(screenId, isBack = false) {
            if (!isBack) App.state.screenHistory.push(screenId);
            document.querySelectorAll('#client-app-wrapper .screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            const isBaseScreen = ['home-screen', 'services-screen', 'my-appointments-screen', 'profile-screen'].includes(screenId);
            App.tg.BackButton.setVisible(!isBaseScreen && App.state.screenHistory.length > 1);
            App.tg.MainButton.setVisible(screenId === 'booking-screen');
            document.getElementById('client-header').style.display = isBaseScreen ? 'flex' : 'none';

            if (screenId === 'booking-screen') App.client.updateConfirmButtonState();
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.screen === screenId));
            window.scrollTo(0, 0);
        },

        goBack() {
            if (App.state.screenHistory.length > 1) {
                App.state.screenHistory.pop();
                App.ui.showScreen(App.state.screenHistory[App.state.screenHistory.length - 1], true);
            }
        },

        renderSkeletons() {
            const skeletonCard = (type) => {
                if(type === 'post') return `<div class="card skeleton"><div class="p-4 flex items-center"><div class="w-8 h-8 rounded-full bg-slate-200 mr-3"></div><div class="h-4 bg-slate-200 rounded w-1/3"></div></div><div class="w-full h-64 bg-slate-200"></div><div class="p-4"><div class="h-4 bg-slate-200 rounded w-full"></div></div></div>`;
                return `<div class="card p-4 flex justify-between items-center skeleton"><div><div class="h-5 bg-slate-200 rounded w-32 mb-2"></div><div class="h-4 bg-slate-200 rounded w-24"></div></div><div class="h-9 w-20 bg-slate-200 rounded-lg"></div></div>`;
            };
            document.getElementById('portfolio-posts').innerHTML = Array(3).fill(skeletonCard('post')).join('');
            document.getElementById('services-list').innerHTML = Array(4).fill(skeletonCard()).join('');
        },

        renderEmptyState(container, message, buttonText, action) {
            container.innerHTML = `<div class="text-center text-slate-500 mt-10"><p>${message}</p>${buttonText ? `<button onclick="${action}" class="btn btn-primary mt-4">${buttonText}</button>` : ''}</div>`;
        },

        renderServices() {
            const list = document.getElementById('services-list');
            if (App.state.services.length === 0) {
                this.renderEmptyState(list, 'Услуги пока не добавлены.');
                return;
            }
            list.innerHTML = App.state.services.map(s => `
                <div class="card p-4 flex justify-between items-center">
                    <div>
                        <h2 class="font-semibold">${s.name}</h2>
                        <p class="text-sm text-slate-500" style="color: var(--hint-color);">${s.duration} / ${s.price} ₽</p>
                    </div>
                    <button onclick='App.client.handleServiceSelect(${JSON.stringify(s)})' class="btn btn-primary text-sm">Выбрать</button>
                </div>
            `).join('');
        },
        
        renderSpecialists() {
            const list = document.getElementById('specialists-list');
            const { specialists } = App.state;
            if (specialists.length === 0) {
                this.renderEmptyState(list, 'Мастера пока не добавлены.');
                return;
            }
            list.innerHTML = specialists.map(s => `
                <div class="card p-4 flex justify-between items-center">
                    <div class="flex items-center">
                        <img src="${s.photo_url}" class="w-12 h-12 rounded-full object-cover mr-4">
                        <div>
                            <h2 class="font-semibold">${s.name}</h2>
                            <p class="text-sm text-slate-500" style="color: var(--hint-color);">${s.specialty}</p>
                        </div>
                    </div>
                    <button onclick='App.client.handleSpecialistSelect(${JSON.stringify(s)})' class="btn btn-primary text-sm">Выбрать</button>
                </div>
            `).join('');
        },

        renderPortfolio() {
            const container = document.getElementById('portfolio-posts');
            if (App.state.portfolio.length === 0) {
                this.renderEmptyState(container, 'В портфолио пока нет работ.');
                return;
            }
            container.innerHTML = App.state.portfolio.map(post => `
                <div class="card" onclick='App.ui.renderPostDetail(${JSON.stringify(post)})'>
                    <div class="p-4 flex items-center">
                        <img src="${App.state.salonConfig.logo_url}" class="w-8 h-8 rounded-full mr-3 object-cover">
                        <span class="font-semibold">${App.state.salonConfig.name}</span>
                    </div>
                    <img src="${post.img_url}" alt="${post.title}" class="w-full h-auto max-h-96 object-cover">
                    <div class="p-4">
                        <p><span class="font-semibold">${App.state.salonConfig.name}</span> ${post.description || ''}</p>
                        <p class="text-xs text-slate-400 mt-2" style="color: var(--hint-color);">${post.comments.length} комментариев</p>
                    </div>
                </div>`).join('');
        },
        
        renderPostDetail(post) {
            const container = document.getElementById('post-view-screen');
            const commentsHtml = post.comments.map(c => `<div class="mb-2"><span class="font-semibold">${c.users.first_name}:</span> ${c.text}</div>`).join('');
            
            container.innerHTML = `
                <div class="p-4">
                    <button onclick="App.ui.goBack()" class="mb-4 text-sm font-semibold flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        Назад
                    </button>
                    <div class="card">
                        <div class="p-4 flex items-center"><img src="${App.state.salonConfig.logo_url}" class="w-8 h-8 rounded-full mr-3 object-cover"><span class="font-semibold">${App.state.salonConfig.name}</span></div>
                        <img src="${post.img_url}" class="w-full h-auto">
                        <div class="p-4">
                            <p class="font-semibold mb-2">${post.title}</p>
                            <p>${post.description || ''}</p>
                        </div>
                    </div>
                    <div class="card mt-4 p-4">
                        <h3 class="font-semibold mb-3">Комментарии</h3>
                        <div class="text-sm space-y-2 mb-4">${commentsHtml || '<p class="text-slate-400">Комментариев пока нет.</p>'}</div>
                        <div class="flex space-x-2">
                            <input id="comment-input-${post.id}" type="text" placeholder="Ваш комментарий..." class="w-full p-2 border rounded-lg">
                            <button onclick="App.client.handlePostComment(${post.id})" class="btn btn-primary px-4">✓</button>
                        </div>
                    </div>
                </div>`;
            this.showScreen('post-view-screen');
        },

        async renderTimeSlots() {
            const container = document.getElementById('time-slots-container');
            container.innerHTML = '<div class="col-span-3 text-center text-slate-500">Загрузка слотов...</div>';
            
            const { date, specialist } = App.state.bookingState;
            const { data } = await App.supabase.from('appointments').select('time').eq('salon_id', App.state.salonId).eq('date', date).eq('specialist_id', specialist.id);
            const bookedTimes = (data || []).map(d => d.time);

            const { start, end, slotDuration } = App.config.workingHours;
            let slots = '';
            for (let hour = start; hour < end; hour++) {
                const time = `${String(hour).padStart(2, '0')}:00`;
                const isBooked = bookedTimes.includes(time);
                slots += `<div onclick="App.client.handleTimeSelect(this, '${time}')" class="time-slot p-2 rounded-lg ${isBooked ? 'disabled' : ''}">${time}</div>`;
            }
            container.innerHTML = slots || '<div class="col-span-3 text-center text-slate-500">Нет доступных слотов на эту дату.</div>';
        },

        renderAppointments() {
            const container = document.getElementById('appointments-list');
            if (App.state.userAppointments.length === 0) {
                this.renderEmptyState(container, 'У вас пока нет записей.', 'Записаться', 'App.ui.showScreen("services-screen")');
                return;
            }

            const now = new Date();
            const upcoming = App.state.userAppointments.filter(a => new Date(a.date + 'T' + a.time) >= now);
            const past = App.state.userAppointments.filter(a => new Date(a.date + 'T' + a.time) < now);

            const renderList = (title, list, showCancel) => {
                if(list.length === 0) return '';
                return `
                    <h2 class="font-bold text-lg mb-3">${title}</h2>
                    <div class="space-y-3 mb-6">
                    ${list.map(a => `
                        <div class="card p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold">${a.service.name}</h3>
                                    <p class="text-sm text-slate-500" style="color: var(--hint-color);">Мастер: ${a.specialist.name}</p>
                                    <p class="text-sm font-semibold mt-1">${App.utils.formatDate(a.date)} в ${a.time}</p>
                                </div>
                                ${showCancel ? `<button onclick="App.client.handleAppointmentCancel(${a.id})" class="text-xs text-red-500 font-semibold">Отменить</button>` : ''}
                            </div>
                        </div>`).join('')}
                    </div>
                `;
            };
            
            container.innerHTML = renderList('Предстоящие', upcoming, true) + renderList('Прошедшие', past, false);
        }
    },

    // ------------------------------------------------------------------
    // Admin Mode
    // ------------------------------------------------------------------
    initAdmin() {
        document.getElementById('admin-mode-wrapper').style.display = 'block';
        if (sessionStorage.getItem('admin_logged_in_' + this.state.salonId)) {
            this.admin.showPanel();
        } else {
            document.getElementById('admin-login-screen').style.display = 'block';
            document.getElementById('login-btn').onclick = () => this.admin.handleLogin();
            document.getElementById('password-input').onkeypress = (e) => { if (e.key === 'Enter') this.admin.handleLogin(); };
        }
    },

    admin: {
        async handleLogin() {
            App.utils.showLoader();
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';
            
            try {
                const { data, error } = await App.supabase.from('salons').select('admin_password').eq('id', App.state.salonId).single();
                if (error || !data) throw new Error('Салон не найден.');
                if (data.admin_password === password) {
                    sessionStorage.setItem('admin_logged_in_' + App.state.salonId, 'true');
                    await App.admin.showPanel();
                } else {
                    errorEl.textContent = 'Неверный пароль.';
                }
            } catch (e) {
                errorEl.textContent = e.message;
            } finally {
                App.utils.hideLoader();
            }
        },

        handleLogout() {
            sessionStorage.removeItem('admin_logged_in_' + App.state.salonId);
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('login-error').textContent = '';
            document.getElementById('password-input').value = '';
            document.getElementById('admin-login-screen').style.display = 'block';
        },
        
        async showPanel() {
            document.getElementById('admin-login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('logout-btn').onclick = () => this.handleLogout();

            App.utils.showLoader();
            await this.loadData();
            this.setupNav();
            this.renderCurrentPanel();
            App.utils.hideLoader();
        },

        setupNav() {
            const navContainer = document.getElementById('admin-nav');
            navContainer.querySelectorAll('.admin-nav-item').forEach(btn => {
                btn.onclick = () => {
                    App.state.currentAdminPanel = btn.dataset.panel;
                    this.renderCurrentPanel();
                };
            });
        },
        
        renderCurrentPanel() {
             document.querySelectorAll('.admin-nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.panel === App.state.currentAdminPanel);
            });
             document.querySelectorAll('.admin-panel-content').forEach(p => p.style.display = 'none');
            
            const panelId = `admin-panel-${App.state.currentAdminPanel}`;
            const panel = document.getElementById(panelId);
            panel.style.display = 'block';
            
            switch(App.state.currentAdminPanel) {
                case 'appointments': this.render.appointments(panel); break;
                case 'services': this.render.services(panel); break;
                case 'specialists': this.render.specialists(panel); break;
                case 'portfolio': this.render.portfolio(panel); break;
                case 'theme': this.render.theme(panel); break;
            }
        },

        async loadData() {
            const { data, error } = await App.supabase.from('salons').select(`*, themes(*), services(*), specialists(*), portfolio_posts(*)`).eq('id', App.state.salonId).single();
            if (error) { alert('Не удалось загрузить данные.'); return; }
            App.state.salonConfig = data;
            
            const { data: appointments } = await App.supabase
                .from('appointments')
                .select('*, services(name), specialists(name), users(first_name)')
                .eq('salon_id', App.state.salonId)
                .order('date', { ascending: true })
                .order('time', { ascending: true });
            
            App.state.allAppointments = appointments || [];
            document.getElementById('admin-salon-name').textContent = App.state.salonConfig.name;
        },

        render: {
            appointments(container) {
                const now = App.utils.getTodayDateString();
                const upcoming = App.state.allAppointments.filter(a => a.date >= now);
                if (upcoming.length === 0) {
                    container.innerHTML = `<div class="admin-card text-center text-slate-500">Предстоящих записей нет.</div>`;
                    return;
                }
                const appointmentsByDate = upcoming.reduce((acc, curr) => {
                    (acc[curr.date] = acc[curr.date] || []).push(curr);
                    return acc;
                }, {});

                container.innerHTML = Object.entries(appointmentsByDate).map(([date, appts]) => `
                    <div class="admin-card">
                        <h3 class="font-bold mb-4">${App.utils.formatDate(date)}</h3>
                        <div class="space-y-3">
                            ${appts.map(a => `
                                <div class="p-3 border rounded-md">
                                    <p class="font-semibold">${a.time} - ${a.services.name}</p>
                                    <p class="text-sm text-slate-600">Клиент: ${a.users.first_name}</p>
                                    <p class="text-sm text-slate-600">Мастер: ${a.specialists.name}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>`).join('');
            },
            
            services(container) {
                container.innerHTML = `
                    <div class="admin-card">
                        <h2 class="text-xl font-semibold mb-4">Услуги</h2>
                        <div id="admin-services-list" class="space-y-2 mb-4">
                        ${(App.state.salonConfig.services || []).map(s => `
                            <div class="flex justify-between items-center p-2 border rounded-md">
                                <span>${s.name} (${s.duration}) - ${s.price} ₽</span>
                                <button onclick="App.admin.actions.deleteItem('services', ${s.id})" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">&times;</button>
                            </div>`).join('') || '<p class="text-slate-500">Нет услуг.</p>'}
                        </div>
                    </div>
                    <div class="admin-card">
                        <h3 class="font-semibold mb-2">Добавить услугу</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input id="new-service-name" placeholder="Название" class="admin-input">
                            <input id="new-service-price" placeholder="Цена (число)" type="number" class="admin-input">
                            <input id="new-service-duration" placeholder="Длительность (напр. 1 час)" class="admin-input">
                        </div>
                        <button onclick="App.admin.actions.addService()" class="btn btn-primary mt-4 bg-pink-600 hover:bg-pink-700">Добавить</button>
                    </div>`;
            },
            
            specialists(container){
                container.innerHTML = `
                    <div class="admin-card">
                        <h2 class="text-xl font-semibold mb-4">Мастера</h2>
                        <div id="admin-specialists-list" class="space-y-2 mb-4">
                         ${(App.state.salonConfig.specialists || []).map(s => `
                            <div class="flex justify-between items-center p-2 border rounded-md">
                                <div class="flex items-center gap-3">
                                  <img src="${s.photo_url}" class="w-10 h-10 rounded-full object-cover"/>
                                  <span>${s.name} - ${s.specialty}</span>
                                </div>
                                <button onclick="App.admin.actions.deleteItem('specialists', ${s.id})" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">&times;</button>
                            </div>`).join('') || '<p class="text-slate-500">Нет мастеров.</p>'}
                        </div>
                    </div>
                    <div class="admin-card">
                        <h3 class="font-semibold mb-2">Добавить мастера</h3>
                        <div class="space-y-4">
                            <input id="new-specialist-name" placeholder="Имя" class="admin-input">
                            <input id="new-specialist-specialty" placeholder="Специальность (напр. Мастер маникюра)" class="admin-input">
                            <input id="new-specialist-photo" placeholder="URL фото" class="admin-input">
                        </div>
                        <button onclick="App.admin.actions.addSpecialist()" class="btn btn-primary mt-4 bg-pink-600 hover:bg-pink-700">Добавить</button>
                    </div>`;
            },
            
            portfolio(container){
                container.innerHTML = `
                    <div class="admin-card">
                        <h2 class="text-xl font-semibold mb-4">Портфолио</h2>
                        <div id="admin-portfolio-list" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                         ${(App.state.salonConfig.portfolio_posts || []).map(p => `
                            <div class="relative">
                                <img src="${p.img_url}" class="w-full h-32 object-cover rounded-md"/>
                                <p class="text-xs mt-1 truncate">${p.title}</p>
                                <button onclick="App.admin.actions.deleteItem('portfolio_posts', ${p.id})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center font-bold text-xs">&times;</button>
                            </div>`).join('') || '<p class="text-slate-500 col-span-full">Нет постов.</p>'}
                        </div>
                    </div>
                    <div class="admin-card">
                        <h3 class="font-semibold mb-2">Добавить пост</h3>
                        <div class="space-y-4">
                            <input id="new-post-title" placeholder="Заголовок" class="admin-input">
                            <input id="new-post-desc" placeholder="Описание" class="admin-input">
                            <input id="new-post-img" placeholder="URL изображения" class="admin-input">
                        </div>
                        <button onclick="App.admin.actions.addPortfolioPost()" class="btn btn-primary mt-4 bg-pink-600 hover:bg-pink-700">Добавить</button>
                    </div>`;
            },
            
            theme(container) {
                const theme = App.state.salonConfig.themes[0] || {};
                container.innerHTML = `
                    <div class="admin-card">
                        <h2 class="text-xl font-semibold mb-4">Внешний вид</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label class="block text-sm font-medium">Кнопки</label><input type="color" id="theme-button-color" value="${theme.button_color || '#c08497'}" class="w-full h-10"></div>
                            <div><label class="block text-sm font-medium">Текст на кнопках</label><input type="color" id="theme-button-text-color" value="${theme.button_text_color || '#ffffff'}" class="w-full h-10"></div>
                            <div><label class="block text-sm font-medium">Фон</label><input type="color" id="theme-bg-color" value="${theme.bg_color || '#f8fafc'}" class="w-full h-10"></div>
                            <div><label class="block text-sm font-medium">Текст</label><input type="color" id="theme-text-color" value="${theme.text_color || '#334155'}" class="w-full h-10"></div>
                        </div>
                        <button onclick="App.admin.actions.saveTheme()" class="btn btn-primary mt-4 bg-pink-600 hover:bg-pink-700">Сохранить тему</button>
                    </div>`;
            }
        },

        actions: {
            async _refreshDataAndRender() {
                App.utils.showLoader();
                await App.admin.loadData();
                App.admin.renderCurrentPanel();
                App.utils.hideLoader();
            },

            async addService() {
                const name = document.getElementById('new-service-name').value.trim();
                const price = document.getElementById('new-service-price').value;
                const duration = document.getElementById('new-service-duration').value.trim();
                if (!name || !price || !duration) { App.utils.showToast('Заполните все поля.'); return; }
                
                const { error } = await App.supabase.from('services').insert([{ salon_id: App.state.salonId, name, price, duration }]);
                if (error) App.utils.showToast('Ошибка: ' + error.message);
                else {
                    App.utils.showToast('Услуга добавлена!');
                    await this._refreshDataAndRender();
                }
            },
            
            async addSpecialist() {
                const name = document.getElementById('new-specialist-name').value.trim();
                const specialty = document.getElementById('new-specialist-specialty').value.trim();
                const photo_url = document.getElementById('new-specialist-photo').value.trim();
                if (!name || !specialty || !photo_url) { App.utils.showToast('Заполните все поля.'); return; }

                const { error } = await App.supabase.from('specialists').insert([{ salon_id: App.state.salonId, name, specialty, photo_url }]);
                if (error) App.utils.showToast('Ошибка: ' + error.message);
                else {
                    App.utils.showToast('Мастер добавлен!');
                    await this._refreshDataAndRender();
                }
            },

            async addPortfolioPost() {
                const title = document.getElementById('new-post-title').value.trim();
                const description = document.getElementById('new-post-desc').value.trim();
                const img_url = document.getElementById('new-post-img').value.trim();
                if (!title || !img_url) { App.utils.showToast('Заполните заголовок и URL.'); return; }

                const { error } = await App.supabase.from('portfolio_posts').insert([{ salon_id: App.state.salonId, title, description, img_url }]);
                if (error) App.utils.showToast('Ошибка: ' + error.message);
                else {
                    App.utils.showToast('Пост добавлен!');
                    await this._refreshDataAndRender();
                }
            },

            async deleteItem(tableName, itemId) {
                if (!confirm('Вы уверены? Это действие необратимо.')) return;
                const { error } = await App.supabase.from(tableName).delete().eq('id', itemId);
                if (error) App.utils.showToast('Ошибка: ' + error.message);
                else {
                    App.utils.showToast('Удалено успешно!');
                    await this._refreshDataAndRender();
                }
            },

            async saveTheme() {
                const themeData = {
                    salon_id: App.state.salonId,
                    button_color: document.getElementById('theme-button-color').value,
                    button_text_color: document.getElementById('theme-button-text-color').value,
                    bg_color: document.getElementById('theme-bg-color').value,
                    text_color: document.getElementById('theme-text-color').value
                };
                const { error } = await App.supabase.from('themes').upsert(themeData, { onConflict: 'salon_id' });
                if (error) App.utils.showToast('Ошибка: ' + error.message);
                else App.utils.showToast('Тема сохранена!');
            }
        }
    }
};

document.addEventListener('DOMContentLoaded', () => App.init());

</script>
</body>
</html>
