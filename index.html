<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Nail Studio Mini App</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏ */
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∏–∫–æ–Ω–∫–∏ –≤ –Ω–∞–≤–±–∞—Ä–µ */
        .nav-item.active svg, .nav-item.active span { color: #4f46e5; /* indigo-600 */ }
        
        /* –°–∫—Ä—ã—Ç–∏–µ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        body { -ms-overflow-style: none; scrollbar-width: none; }
        body::-webkit-scrollbar { display: none; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–∫–∏ –ª–∞–π–∫–∞ */
        .like-btn.liked svg.solid { display: block; color: #ef4444; animation: pop 0.3s ease; }
        .like-btn.liked svg.outline { display: none; }
        .like-btn svg.solid { display: none; }
        @keyframes pop {
            0% { transform: scale(0.8); }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        /* –°—Ç–∏–ª—å –¥–ª—è –∑–∞–≥—Ä—É–∑—á–∏–∫–∞ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-black text-gray-900 dark:text-gray-100 font-sans antialiased overflow-x-hidden text-sm">

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app-container" class="pb-16">

        <!-- ===== –≠–ö–†–ê–ù 1: –ü–û–†–¢–§–û–õ–ò–û ===== -->
        <div id="portfolio-page" class="page active p-3 space-y-3">
            <h1 class="text-xl font-bold px-1">–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</h1>
            <div id="portfolio-grid" class="space-y-4">
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –±—É–¥—É—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è –∑–¥–µ—Å—å -->
                 <div class="flex justify-center items-center h-64"><div class="loader"></div></div>
            </div>
        </div>

        <!-- ===== –≠–ö–†–ê–ù 2: –ó–ê–ü–ò–°–¨ ===== -->
        <div id="booking-page" class="page p-3 space-y-4">
            <h1 class="text-xl font-bold px-1">–ó–∞–ø–∏—Å—å –Ω–∞ —É—Å–ª—É–≥—É</h1>
            <div id="step-1-service">
                <h2 class="text-base font-semibold mb-2 px-1">1. –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</h2>
                <div id="services-list" class="space-y-2">
                    <div class="flex justify-center items-center h-32"><div class="loader"></div></div>
                </div>
            </div>
            <div id="step-2-datetime" class="hidden">
                <h2 class="text-base font-semibold mb-2 px-1">2. –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è</h2>
                <input type="date" id="date-picker" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-800 border-none focus:ring-2 focus:ring-indigo-500">
                <div id="time-slots-loader" class="flex justify-center items-center h-32 hidden"><div class="loader"></div></div>
                <div id="time-slots" class="grid grid-cols-4 gap-2 mt-3"></div>
                <p id="no-slots-message" class="text-center text-gray-500 mt-4 hidden">–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤.</p>
            </div>
            <button id="back-to-services" class="hidden w-full mt-3 p-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-center font-semibold">–ù–∞–∑–∞–¥ –∫ —É—Å–ª—É–≥–∞–º</button>
        </div>

        <!-- ===== –≠–ö–†–ê–ù 3: –ú–û–ò –ó–ê–ü–ò–°–ò ===== -->
        <div id="history-page" class="page p-3 space-y-3">
            <h1 class="text-xl font-bold px-1">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h1>
            <div id="appointments-list" class="space-y-3">
                <div class="flex justify-center items-center h-64"><div class="loader"></div></div>
            </div>
        </div>

        <!-- ===== –≠–ö–†–ê–ù 4: –ü–†–û–§–ò–õ–¨ ===== -->
        <div id="profile-page" class="page p-3 space-y-4">
            <h1 class="text-xl font-bold px-1">–ü—Ä–æ—Ñ–∏–ª—å</h1>
            <div class="bg-white dark:bg-gray-900 p-4 rounded-xl shadow-sm flex items-center space-x-3">
                <div id="user-photo" class="w-14 h-14 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xl font-bold shrink-0"></div>
                <div>
                    <h2 id="user-name" class="text-lg font-semibold">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                    <p id="user-username" class="text-gray-500 dark:text-gray-400 text-xs"></p>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-900 p-2 rounded-xl shadow-sm">
                <ul class="space-y-1">
                    <li class="flex justify-between items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg cursor-pointer">
                        <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                        <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                    </li>
                    <li class="flex justify-between items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg cursor-pointer">
                        <span>–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏</span>
                        <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ===== –ù–ò–ñ–ù–ò–ô –ù–ê–í–ë–ê–† ===== -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm border-t border-gray-200 dark:border-gray-800 flex justify-around">
        <button data-page="portfolio-page" class="nav-item active flex-1 flex flex-col items-center justify-center p-2 text-gray-500 dark:text-gray-400">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
            <span class="text-xs font-medium mt-0.5">–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</span>
        </button>
        <button data-page="booking-page" class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-gray-500 dark:text-gray-400">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M12 15.75h.008v.008H12v-.008z" /></svg>
            <span class="text-xs font-medium mt-0.5">–ó–∞–ø–∏—Å—å</span>
        </button>
        <button data-page="history-page" class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-gray-500 dark:text-gray-400">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span class="text-xs font-medium mt-0.5">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</span>
        </button>
        <button data-page="profile-page" class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-gray-500 dark:text-gray-400">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
            <span class="text-xs font-medium mt-0.5">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </button>
    </nav>
    
    <!-- Firebase SDK -->
    <script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, onSnapshot, query, addDoc, deleteDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            // --- FIREBASE SETUP ---
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-nail-app';

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            let currentTgUser = tg.initDataUnsafe.user;
            let userAppointmentsCache = []; 
            
            // --- –ü–£–¢–ò –ö –î–ê–ù–ù–´–ú ---
            const timeSlotsData = ['09:00', '10:00', '11:00', '12:00', '14:00', '15:00', '16:00', '17:00'];
            const publicDataPath = `artifacts/${appId}/public/data`;

            // --- UI –≠–õ–ï–ú–ï–ù–¢–´ ---
            const pages = document.querySelectorAll('.page');
            const navItems = document.querySelectorAll('.nav-item');
            const portfolioGrid = document.getElementById('portfolio-grid');
            const servicesList = document.getElementById('services-list');
            const appointmentsList = document.getElementById('appointments-list');
            const datePicker = document.getElementById('date-picker');
            const timeSlotsContainer = document.getElementById('time-slots');
            const timeSlotsLoader = document.getElementById('time-slots-loader');
            const noSlotsMessage = document.getElementById('no-slots-message');
            const step1 = document.getElementById('step-1-service');
            const step2 = document.getElementById('step-2-datetime');
            const backBtn = document.getElementById('back-to-services');
            let selectedService = null;
            let selectedTime = null;

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã
            const body = document.querySelector('body');
            if (tg.colorScheme === 'dark') {
                body.classList.add('dark');
            }
            tg.setHeaderColor(body.classList.contains('dark') ? '#000000' : '#f9fafb');

            // --- –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Firebase —Å–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞, —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–∞–Ω–Ω—ã–º–∏
                    initializeApp();
                } else {
                    signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                }
            });

            // NEW: –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            async function initializeUserProfile() {
                if (!currentTgUser) {
                    console.error("Telegram user data is not available.");
                    tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram.");
                    return;
                }
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram ID –∫–∞–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–æ–∫—É–º–µ–Ω—Ç–∞
                const userDocRef = doc(db, `${publicDataPath}/users`, String(currentTgUser.id));
                const docSnap = await getDoc(userDocRef);

                if (!docSnap.exists()) {
                    // –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
                    const newUserProfile = {
                        tgId: currentTgUser.id,
                        firstName: currentTgUser.first_name,
                        lastName: currentTgUser.last_name || null,
                        username: currentTgUser.username || null,
                        createdAt: new Date()
                    };
                    try {
                        await setDoc(userDocRef, newUserProfile);
                        console.log("New user profile created:", currentTgUser.id);
                    } catch (error) {
                        console.error("Error creating user profile:", error);
                    }
                } else {
                    console.log("User profile already exists:", currentTgUser.id);
                }
            }

            async function initializeApp() {
                await initializeUserProfile(); // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º/—Å–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                renderProfile();
                renderPortfolio();
                renderServices();
                listenForAppointments(); 
            }

            // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
            function switchPage(pageId) {
                pages.forEach(page => page.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
                tg.MainButton.hide();
                resetBookingFlow();
            }
            navItems.forEach(item => item.addEventListener('click', () => switchPage(item.dataset.page)));

            // --- –§–£–ù–ö–¶–ò–ò –†–ï–ù–î–ï–†–ê ---

            async function renderPortfolio() {
                const portfolioCol = collection(db, `${publicDataPath}/portfolio`);
                try {
                    const portfolioSnapshot = await getDocs(portfolioCol);
                    if (portfolioSnapshot.empty) {
                        await addDemoPortfolio();
                        renderPortfolio(); 
                        return;
                    }
                    portfolioGrid.innerHTML = '';
                    portfolioSnapshot.docs.sort((a, b) => a.data().order - b.data().order).forEach(doc => {
                        const post = { id: doc.id, ...doc.data() };
                        const postElement = document.createElement('div');
                        postElement.className = 'bg-white dark:bg-gray-900 rounded-xl shadow-sm overflow-hidden';
                        postElement.innerHTML = `
                            <img src="${post.imageUrl}" alt="Nail Art" class="w-full h-auto object-cover" onerror="this.src='https://placehold.co/600x400/e0e0e0/333?text=Error'">
                            <div class="p-3">
                                <p class="text-gray-700 dark:text-gray-300 mb-3 text-xs">${post.description}</p>
                            </div>`;
                        portfolioGrid.appendChild(postElement);
                    });
                } catch (error) {
                    console.error("Error fetching portfolio:", error);
                }
            }

            async function renderServices() {
                const servicesCol = collection(db, `${publicDataPath}/services`);
                 try {
                    const servicesSnapshot = await getDocs(servicesCol);
                    if (servicesSnapshot.empty) {
                        await addDemoServices();
                        renderServices();
                        return;
                    }
                    servicesList.innerHTML = '';
                    servicesSnapshot.docs.sort((a,b) => a.data().order - b.data().order).forEach(doc => {
                        const service = { id: doc.id, ...doc.data() };
                        const serviceEl = document.createElement('div');
                        serviceEl.className = 'bg-white dark:bg-gray-900 p-3 rounded-xl shadow-sm flex justify-between items-center cursor-pointer active:bg-indigo-50 dark:active:bg-gray-800';
                        serviceEl.innerHTML = `
                            <div>
                                <h3 class="font-semibold">${service.name}</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${service.duration}</p>
                            </div>
                            <span class="font-bold text-indigo-600 dark:text-indigo-400">${service.price}</span>`;
                        serviceEl.addEventListener('click', () => handleServiceSelect(service));
                        servicesList.appendChild(serviceEl);
                    });
                } catch (error) {
                    console.error("Error fetching services:", error);
                }
            }
            
            async function renderTimeSlots() {
                const selectedDate = datePicker.value;
                if (!selectedDate) return;

                timeSlotsContainer.innerHTML = '';
                noSlotsMessage.classList.add('hidden');
                timeSlotsLoader.classList.remove('hidden');
                tg.MainButton.hide();

                try {
                    const dailySlotsDocRef = doc(db, `${publicDataPath}/dailySlots`, selectedDate);
                    const docSnap = await getDoc(dailySlotsDocRef);
                    const bookedTimes = docSnap.exists() ? docSnap.data().times || [] : [];
                    
                    timeSlotsContainer.innerHTML = '';
                    const availableSlots = timeSlotsData.filter(slot => !bookedTimes.includes(slot));

                    if (availableSlots.length === 0) {
                        noSlotsMessage.classList.remove('hidden');
                    }

                    timeSlotsData.forEach(time => {
                        const slotEl = document.createElement('button');
                        const isBooked = bookedTimes.includes(time);
                        slotEl.className = `p-2 rounded-lg text-center font-semibold ${isBooked ? 'bg-gray-100 dark:bg-gray-800 text-gray-400 cursor-not-allowed' : 'bg-gray-200 dark:bg-gray-800 active:bg-indigo-500 active:text-white focus:bg-indigo-500 focus:text-white'}`;
                        slotEl.textContent = time;
                        slotEl.disabled = isBooked;
                        if (!isBooked) {
                            slotEl.addEventListener('click', () => handleTimeSlotSelect(time, slotEl));
                        }
                        timeSlotsContainer.appendChild(slotEl);
                    });
                } catch (error) {
                    console.error("Error fetching time slots: ", error);
                    timeSlotsContainer.innerHTML = `<p class="text-center text-red-500 col-span-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—Ç–æ–≤.</p>`;
                } finally {
                    timeSlotsLoader.classList.add('hidden');
                }
            }

            // FIX: –ü—É—Ç—å –∫ –∑–∞–ø–∏—Å—è–º —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Telegram ID
            function listenForAppointments() {
                if (!currentTgUser) return;
                const privateAppointmentsPath = `artifacts/${appId}/users/${currentTgUser.id}/appointments`;
                const appointmentsCol = collection(db, privateAppointmentsPath);

                onSnapshot(appointmentsCol, (snapshot) => {
                    userAppointmentsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    appointmentsList.innerHTML = '';

                    if (userAppointmentsCache.length === 0) {
                        appointmentsList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 mt-8">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.</p>`;
                        return;
                    }
                    
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const upcoming = userAppointmentsCache
                        .filter(a => new Date(a.date) >= today)
                        .sort((a,b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
                    
                    const completed = userAppointmentsCache
                        .filter(a => new Date(a.date) < today)
                        .sort((a,b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));

                    if (upcoming.length > 0) {
                        appointmentsList.innerHTML += `<h2 class="text-base font-semibold text-gray-600 dark:text-gray-300 px-1">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</h2>`;
                        upcoming.forEach(app => appointmentsList.appendChild(createAppointmentCard(app, true)));
                    }
                    if (completed.length > 0) {
                        appointmentsList.innerHTML += `<h2 class="text-base font-semibold text-gray-600 dark:text-gray-300 mt-4 px-1">–ü—Ä–æ—à–µ–¥—à–∏–µ</h2>`;
                        completed.forEach(app => appointmentsList.appendChild(createAppointmentCard(app, false)));
                    }
                }, (error) => {
                    console.error("Error listening for appointments:", error);
                    appointmentsList.innerHTML = `<p class="text-center text-red-500">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–ø–∏—Å–∏.</p>`;
                });
            }

            function createAppointmentCard(appointment, isUpcoming) {
                const card = document.createElement('div');
                card.className = `bg-white dark:bg-gray-900 p-3 rounded-xl shadow-sm`;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-base">${appointment.serviceName}</h3>
                            <p class="text-gray-500 dark:text-gray-400 text-xs">${new Date(appointment.date).toLocaleDateString('ru-RU', {day: 'numeric', month: 'long', year: 'numeric'})} –≤ ${appointment.time}</p>
                        </div>
                        <span class="text-xs font-medium py-1 px-2 rounded-full ${isUpcoming ? 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200' : 'bg-gray-200 text-gray-700 dark:bg-gray-800 dark:text-gray-200'}">
                            ${isUpcoming ? '–ü—Ä–µ–¥—Å—Ç–æ–∏—Ç' : '–ó–∞–≤–µ—Ä—à–µ–Ω–∞'}
                        </span>
                    </div>
                    ${isUpcoming ? `<button data-id="${appointment.id}" class="cancel-btn w-full text-left text-red-500 font-semibold mt-2 p-2 -mb-1 -mx-1 rounded-lg active:bg-red-50 dark:active:bg-red-900/50">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>` : ''}
                `;
                return card;
            }

            function renderProfile() {
                if (currentTgUser) {
                    document.getElementById('user-name').textContent = `${currentTgUser.first_name || ''} ${currentTgUser.last_name || ''}`.trim();
                    document.getElementById('user-username').textContent = currentTgUser.username ? `@${currentTgUser.username}` : `ID: ${currentTgUser.id}`;
                    const userPhoto = document.getElementById('user-photo');
                    const initials = (currentTgUser.first_name ? currentTgUser.first_name[0] : '') + (currentTgUser.last_name ? currentTgUser.last_name[0] : '');
                    userPhoto.textContent = initials ? initials.toUpperCase() : 'üë§';
                }
            }

            // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ---

            function handleServiceSelect(service) {
                selectedService = service;
                step1.classList.add('hidden');
                step2.classList.remove('hidden');
                backBtn.classList.remove('hidden');
                const today = new Date().toISOString().split('T')[0];
                datePicker.value = today;
                datePicker.min = today;
                renderTimeSlots();
            }

            function handleTimeSlotSelect(time, el) {
                selectedTime = time;
                document.querySelectorAll('#time-slots button').forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    if(!btn.disabled) btn.classList.add('bg-gray-200', 'dark:bg-gray-800');
                });
                el.classList.add('bg-indigo-600', 'text-white');
                el.classList.remove('bg-gray-200', 'dark:bg-gray-800');
                
                tg.MainButton.setText(`–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ ${time}`);
                tg.MainButton.show();
                tg.MainButton.onClick(confirmBooking);
            }

            async function confirmBooking() {
                if (!selectedService || !selectedTime || !datePicker.value || !currentTgUser) return;
                
                const date = datePicker.value;
                const time = selectedTime;

                const details = `–£—Å–ª—É–≥–∞: ${selectedService.name}\n–î–∞—Ç–∞: ${date}\n–í—Ä–µ–º—è: ${time}\n\n–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å?`;
                
                tg.showConfirm(details, async (confirmed) => {
                    if (confirmed) {
                        tg.MainButton.showProgress();
                        try {
                            // FIX: –ü—É—Ç—å –∫ –∑–∞–ø–∏—Å—è–º —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Telegram ID
                            const privateAppointmentsPath = `artifacts/${appId}/users/${currentTgUser.id}/appointments`;
                            const appointmentsCol = collection(db, privateAppointmentsPath);
                            const newAppointment = {
                                serviceId: selectedService.id,
                                serviceName: selectedService.name,
                                date: date,
                                time: time,
                                createdAt: new Date()
                            };
                            await addDoc(appointmentsCol, newAppointment);
                            
                            const dailySlotsDocRef = doc(db, `${publicDataPath}/dailySlots`, date);
                            const docSnap = await getDoc(dailySlotsDocRef);
                            const existingTimes = docSnap.exists() ? docSnap.data().times || [] : [];
                            if (!existingTimes.includes(time)) {
                                await setDoc(dailySlotsDocRef, { times: [...existingTimes, time] }, { merge: true });
                            }
                            
                            tg.HapticFeedback.notificationOccurred('success');
                            tg.showAlert('–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã!', () => {
                                switchPage('history-page');
                            });

                        } catch (error) {
                            console.error("Error creating appointment: ", error);
                            tg.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                        } finally {
                            tg.MainButton.hideProgress();
                            tg.MainButton.hide();
                        }
                    }
                });
            }
            
            appointmentsList.addEventListener('click', async (e) => {
                const button = e.target.closest('.cancel-btn');
                if (!button) return;
                const appointmentId = button.dataset.id;
                const appointmentToCancel = userAppointmentsCache.find(app => app.id === appointmentId);

                if (!appointmentToCancel) return;
                
                tg.showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?', async (confirmed) => {
                    if(confirmed) {
                        try {
                            // FIX: –ü—É—Ç—å –∫ –∑–∞–ø–∏—Å—è–º —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Telegram ID
                            const privateAppointmentsPath = `artifacts/${appId}/users/${currentTgUser.id}/appointments`;
                            await deleteDoc(doc(db, privateAppointmentsPath, appointmentId));
                            
                            const dailySlotsDocRef = doc(db, `${publicDataPath}/dailySlots`, appointmentToCancel.date);
                            const docSnap = await getDoc(dailySlotsDocRef);
                            if (docSnap.exists()) {
                                const existingTimes = docSnap.data().times || [];
                                const newTimes = existingTimes.filter(t => t !== appointmentToCancel.time);
                                await setDoc(dailySlotsDocRef, { times: newTimes });
                            }
                            
                            tg.HapticFeedback.notificationOccurred('success');
                        } catch (error) {
                            console.error("Error canceling appointment: ", error);
                            tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å.');
                        }
                    }
                });
            });

            backBtn.addEventListener('click', resetBookingFlow);
            datePicker.addEventListener('change', renderTimeSlots);

            function resetBookingFlow() {
                step1.classList.remove('hidden');
                step2.classList.add('hidden');
                backBtn.classList.add('hidden');
                tg.MainButton.hide();
                selectedService = null;
                selectedTime = null;
                timeSlotsContainer.innerHTML = '';
            }

            // --- –î–ï–ú–û-–î–ê–ù–ù–´–ï (–¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞) ---
            async function addDemoServices() {
                const services = [
                    { id: "1", name: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–∞–Ω–∏–∫—é—Ä', price: '1500 ‚ÇΩ', duration: '60 –º–∏–Ω', order: 1 },
                    { id: "2", name: '–ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ (–≥–µ–ª—å)', price: '3500 ‚ÇΩ', duration: '120 –º–∏–Ω', order: 2 },
                    { id: "3", name: '–ö–æ—Ä—Ä–µ–∫—Ü–∏—è', price: '2500 ‚ÇΩ', duration: '90 –º–∏–Ω', order: 3 },
                ];
                for (const service of services) {
                    await setDoc(doc(db, `${publicDataPath}/services`, service.id), service);
                }
            }
            async function addDemoPortfolio() {
                const portfolio = [
                    { id: "1", imageUrl: 'https://placehold.co/600x800/d1d5db/374151?text=Nail+Art+1', description: '–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π —Ñ—Ä–µ–Ω—á —Å –≥–ª–∏—Ç—Ç–µ—Ä–æ–º.', order: 1 },
                    { id: "2", imageUrl: 'https://placehold.co/600x800/fecaca/991b1b?text=Nail+Art+2', description: '–Ø—Ä–∫–∏–π –ª–µ—Ç–Ω–∏–π –¥–∏–∑–∞–π–Ω.', order: 2 },
                ];
                for (const item of portfolio) {
                    await setDoc(doc(db, `${publicDataPath}/portfolio`, item.id), item);
                }
            }
        });
    </script>
</body>
</html>
