<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –°–∞–ª–æ–Ω–∞ –ö—Ä–∞—Å–æ—Ç—ã</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc;
            --secondary-bg-color: #ffffff;
            --text-color: #334155;
            --hint-color: #94a3b8;
            --border-color: #e2e8f0;
            --button-color: #c08497;
            --button-text-color: #ffffff;
            --header-bg-color: #ffffff;
            --danger-color: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); -webkit-tap-highlight-color: transparent; }
        .main-container { padding-bottom: 80px; }
        .btn-primary { background-color: var(--button-color); color: var(--button-text-color); }
        .btn { font-weight: 600; border-radius: 0.75rem; padding: 0.65rem 1.5rem; transition: all 0.2s; text-align: center; }
        .btn:hover { opacity: 0.9; transform: scale(1.02); }
        .btn:disabled { background-color: #cbd5e1; cursor: not-allowed; opacity: 0.7; }
        .card { background-color: var(--secondary-bg-color); border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07); }
        .screen { display: none; animation: fadeIn 0.3s ease-out; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.3s; backdrop-filter: blur(4px); }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--button-color); animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .admin-input { @apply w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition; }
        .admin-card { @apply bg-white p-4 sm:p-6 rounded-lg shadow-md mb-6; }
        
        .time-slot { cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s; }
        .time-slot.selected { background-color: var(--button-color); color: var(--button-text-color); border-color: var(--button-color); transform: scale(1.05); box-shadow: 0 0 10px rgba(192, 132, 151, 0.5); }
        .time-slot:not(.disabled):hover { background-color: #fde6ea; border-color: #fde6ea; }
        .time-slot.disabled { background-color: #f1f5f9; color: var(--hint-color); cursor: not-allowed; opacity: 0.7; }
        
        .nav-item { color: var(--hint-color); transition: all 0.2s; }
        .nav-item.active { color: var(--button-color); background-color: #fde6ea; }
        .nav-item.active svg { color: var(--button-color); }

        #toast-container { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .toast { background-color: rgba(0,0,0,0.75); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; animation: toast-in 0.3s ease, toast-out 0.3s ease 2.7s forwards; backdrop-filter: blur(2px); }
        @keyframes toast-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }

        .form-error { color: var(--danger-color); font-size: 0.8rem; margin-top: 4px; display: none; }

        /* Modal */
        #modal-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; display: none; justify-content: center; align-items: center; animation: fadeIn 0.2s ease; backdrop-filter: blur(4px); }
        #modal-container.active { display: flex; }
        .modal-content { background: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 350px; text-align: center; animation: zoomIn 0.2s ease; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Skeleton Loader */
        .skeleton { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .skeleton-card { background-color: var(--secondary-bg-color); border-radius: 1rem; padding: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07); }
    </style>
</head>
<body class="antialiased text-sm">

    <div id="loader"><div class="spinner"></div></div>
    <div id="toast-container"></div>
    <div id="modal-container"></div>

    <div id="constructor-wrapper">
        <div id="setup-screen" class="screen p-6 min-h-screen flex-col justify-center items-center">
             <div class="w-full max-w-md text-center">
                 <h1 class="text-2xl font-bold mb-2">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π —Å–∞–ª–æ–Ω üíÖ</h1>
                 <p class="text-slate-500 mb-8">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.</p>
                 <form id="setup-form" class="card p-6 text-left !mb-6">
                     <div class="mb-4">
                         <label for="salon-name-input" class="block font-semibold mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–ª–æ–Ω–∞</label>
                         <input type="text" id="salon-name-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, Beauty Haven" class="w-full p-3 border rounded-lg" required>
                         <span class="form-error" id="salon-name-input-error"></span>
                     </div>
                     <div class="mb-4">
                         <label for="logo-url-input" class="block font-semibold mb-2">URL –ª–æ–≥–æ—Ç–∏–ø–∞</label>
                         <input type="url" id="logo-url-input" placeholder="https://example.com/logo.png" class="w-full p-3 border rounded-lg" required>
                         <span class="form-error" id="logo-url-input-error"></span>
                     </div>
                     <div class="mb-6">
                         <label for="salon-admin-password" class="block font-semibold mb-2">–ü–∞—Ä–æ–ª—å –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</label>
                         <input type="password" id="salon-admin-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-3 border rounded-lg" required minlength="6">
                         <span class="form-error" id="salon-admin-password-error"></span>
                     </div>
                     <button id="generate-link-btn" type="submit" class="btn btn-primary w-full py-3">–°–æ–∑–¥–∞—Ç—å —Å–∞–ª–æ–Ω</button>
                 </form>
                 <div id="link-result" class="text-left" style="display: none;">
                     <div class="card p-4 space-y-4">
                         <div>
                             <label class="block font-semibold mb-2 text-sm">‚úÖ –ì–æ—Ç–æ–≤–æ! –°—Å—ã–ª–∫–∞ –¥–ª—è –≤–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤:</label>
                             <div class="flex space-x-2"><input type="text" id="generated-client-link" readonly class="w-full p-2 border rounded-lg bg-slate-100 text-xs"><button onclick="App.copyLink('generated-client-link')" class="btn btn-primary text-sm px-4">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
                         </div>
                         <div>
                             <label class="block font-semibold mb-2 text-sm text-red-600">‚ö†Ô∏è –í–∞—à–∞ —Å–µ–∫—Ä–µ—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:</label>
                             <div class="flex space-x-2"><input type="text" id="generated-admin-link" readonly class="w-full p-2 border rounded-lg bg-slate-100 text-xs"><button onclick="App.copyLink('generated-admin-link')" class="btn btn-primary text-sm px-4">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
                         </div>
                     </div>
                 </div>
             </div>
        </div>
    </div>
    
    <div id="client-app-wrapper" style="display: none;">
        <div class="main-container min-h-screen">
            
            <header id="client-header" class="flex items-center p-4 pt-6 bg-white shadow-sm sticky top-0 z-20" style="background-color: var(--header-bg-color);">
                <img id="salon-logo-header" src="" alt="Logo" class="w-10 h-10 rounded-full object-cover">
                <h1 id="salon-name-header" class="text-xl font-bold text-slate-800 ml-3" style="color: var(--text-color);"></h1>
            </header>
            
            <div id="home-screen" class="screen">
                <div id="portfolio-posts" class="space-y-1 bg-slate-100 pt-1" style="background-color: var(--bg-color);"></div>
            </div>

            <div id="post-view-screen" class="screen"></div>
            
            <div id="services-screen" class="screen p-4">
                <h1 class="text-xl font-bold mb-5">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</h1>
                <div id="services-list" class="space-y-3"></div>
            </div>

            <div id="specialist-selection-screen" class="screen p-4">
                <h1 class="text-xl font-bold mb-5">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞</h1>
                <div id="specialists-list" class="space-y-3"></div>
            </div>
            
            <div id="booking-screen" class="screen p-4">
                <h1 class="text-xl font-bold mb-5">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è</h1>
                <div class="card p-4 mb-4">
                    <h2 class="font-semibold mb-1 text-base" id="selected-service-title"></h2>
                    <p class="text-sm text-slate-500" id="selected-specialist-subtitle" style="color: var(--hint-color);"></p>
                </div>
                <div class="card p-4">
                    <input type="date" id="date-picker" class="w-full p-2 border rounded-lg mb-4">
                    <h2 class="font-semibold mb-3">–î–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è:</h2>
                    <div id="time-slots-container" class="grid grid-cols-3 sm:grid-cols-4 gap-3 text-center text-xs"></div>
                </div>
            </div>
            
            <div id="my-appointments-screen" class="screen p-4">
                <h1 class="text-xl font-bold mb-5">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h1>
                <div id="appointments-list"></div>
            </div>
            
            <div id="profile-screen" class="screen p-4">
                <h1 class="text-xl font-bold mb-5">–ü—Ä–æ—Ñ–∏–ª—å</h1>
                <div class="card p-4 flex items-center">
                    <img id="profile-avatar" src="" alt="Avatar" class="w-16 h-16 rounded-full mr-4">
                    <div>
                        <h2 id="profile-name" class="font-bold text-lg"></h2>
                        <p class="text-slate-500" style="color: var(--hint-color);">–î–∞–Ω–Ω—ã–µ –∏–∑ Telegram</p>
                    </div>
                </div>
            </div>

            <div id="success-screen" class="screen text-center p-8 flex flex-col justify-center items-center min-h-[80vh]">
                <div>
                    <div class="mb-5"><svg class="w-16 h-16 text-green-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <h1 class="text-xl font-bold mb-2">–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã!</h1>
                    <p class="text-slate-600 mb-6" id="success-details" style="color: var(--hint-color);"></p>
                    <button onclick="App.ui.showScreen('my-appointments-screen')" class="btn btn-primary">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–æ–∏ –∑–∞–ø–∏—Å–∏</button>
                </div>
            </div>
        </div>

        <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)] flex justify-around p-2 z-30" style="background-color: var(--secondary-bg-color);">
            <button data-screen="home-screen" class="nav-item flex flex-col items-center justify-center w-full text-xs p-1 rounded-lg"><svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
            <button data-screen="services-screen" class="nav-item flex flex-col items-center justify-center w-full text-xs p-1 rounded-lg"><svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.75h16.5m-16.5 4.5h16.5m-16.5 4.5h16.5M6.75 21v-5.625a3.375 3.375 0 013.375-3.375h3.75a3.375 3.375 0 013.375 3.375V21" /></svg><span>–ó–∞–ø–∏—Å—å</span></button>
            <button data-screen="my-appointments-screen" class="nav-item flex flex-col items-center justify-center w-full text-xs p-1 rounded-lg"><svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M12 15.75h.008v.008H12v-.008z" /></svg><span>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</span></button>
            <button data-screen="profile-screen" class="nav-item flex flex-col items-center justify-center w-full text-xs p-1 rounded-lg"><svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
        </nav>
    </div>

    <div id="admin-mode-wrapper" style="display: none;" class="p-4 md:p-8 bg-slate-50 min-h-screen">
        <div id="admin-login-screen" class="max-w-md mx-auto">
            <div class="admin-card mt-10">
                <h1 class="text-2xl font-bold mb-4">–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
                <p class="mb-4 text-gray-600">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –æ—Ç –≤–∞—à–µ–≥–æ —Å–∞–ª–æ–Ω–∞.</p>
                <form id="admin-login-form">
                    <input type="password" id="password-input" class="admin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    <button id="login-btn" type="submit" class="btn btn-primary w-full mt-4 bg-pink-600 hover:bg-pink-700">–í–æ–π—Ç–∏</button>
                    <p id="login-error" class="text-red-500 mt-2 text-sm text-center"></p>
                </form>
            </div>
        </div>

        <div id="admin-panel" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl sm:text-3xl font-bold">–ü–∞–Ω–µ–ª—å "<span id="admin-salon-name"></span>"</h1>
                <button id="logout-btn" class="text-sm text-slate-500 hover:text-slate-800">–í—ã–π—Ç–∏</button>
            </div>
            
            <div class="mb-6 border-b border-slate-200">
                <nav class="-mb-px flex space-x-6" id="admin-nav">
                    <button data-panel="appointments" class="admin-nav-item whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">–ó–∞–ø–∏—Å–∏</button>
                    <button data-panel="services" class="admin-nav-item whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">–£—Å–ª—É–≥–∏</button>
                    <button data-panel="specialists" class="admin-nav-item whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">–ú–∞—Å—Ç–µ—Ä–∞</button>
                    <button data-panel="portfolio" class="admin-nav-item whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</button>
                    <button data-panel="theme" class="admin-nav-item whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">–¢–µ–º–∞</button>
                    <button data-panel="settings" class="admin-nav-item whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                </nav>
            </div>
            <style>
                .admin-nav-item { border-color: transparent; color: #64748b; }
                .admin-nav-item.active { border-color: var(--button-color); color: var(--button-color); }
            </style>
            
            <div id="admin-panels-container">
                <div id="admin-panel-appointments" class="admin-panel-content"></div>
                <div id="admin-panel-services" class="admin-panel-content"></div>
                <div id="admin-panel-specialists" class="admin-panel-content"></div>
                <div id="admin-panel-portfolio" class="admin-panel-content"></div>
                <div id="admin-panel-theme" class="admin-panel-content"></div>
                <div id="admin-panel-settings" class="admin-panel-content"></div>
            </div>
        </div>
    </div>


<script>
// ==================================================================
// ==================================================================
//                      BEAUTY SALON MINI APP SCRIPT
// ==================================================================
// ==================================================================

const App = {

    // ------------------------------------------------------------------
    // Properties
    // ------------------------------------------------------------------
    tg: window.Telegram.WebApp,
    supabase: null,
    
    config: {
        // !!! –í–ê–ñ–ù–û: –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ Row Level Security (RLS) –≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ Supabase.
        // –≠—Ç–æ—Ç 'anon' –∫–ª—é—á —è–≤–ª—è–µ—Ç—Å—è –ø—É–±–ª–∏—á–Ω—ã–º, –∏ –µ–≥–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ
        // –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏–∫–∞—Ö RLS –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã.
        supabaseUrl: 'https://iwvglucrgnwetczrzwqk.supabase.co',
        supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3dmdsdWNyZ253ZXRjenJ6d3FrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzY3NDgsImV4cCI6MjA3MDk1Mjc0OH0.Cn8YUKAlGyQKpZkXUxSHE9gQwsn0BFtH9GcaSJSpEiQ',
    },

    state: {
        salonId: null,
        salonConfig: {},
        currentUser: {},
        services: [],
        specialists: [],
        portfolio: [],
        userAppointments: [],
        allAppointments: [],
        bookingState: {},
        screenHistory: ['home-screen'],
        currentAdminPanel: 'appointments'
    },

    elements: {
        loader: null,
        toastContainer: null,
        modalContainer: null,
    },

    // ------------------------------------------------------------------
    // Initializer
    // ------------------------------------------------------------------
    init() {
        console.log("App Initializing...");
        this.supabase = supabase.createClient(this.config.supabaseUrl, this.config.supabaseKey);
        this.elements.loader = document.getElementById('loader');
        this.elements.toastContainer = document.getElementById('toast-container');
        this.elements.modalContainer = document.getElementById('modal-container');
        
        this.tg.ready();
        this.tg.expand();
        this.tg.setHeaderColor('#ffffff'); // Default header color
        
        this.router();
    },

    // ------------------------------------------------------------------
    // Core Utilities
    // ------------------------------------------------------------------
    async router() {
        this.utils.showLoader();
        try {
            const params = new URLSearchParams(this.tg.initDataUnsafe?.start_param ? `?${this.tg.initDataUnsafe.start_param}` : window.location.hash.substring(1));
            this.state.salonId = params.get('salonId');
            const mode = params.get('mode');

            if (mode === 'admin' && this.state.salonId) {
                this.initAdmin();
            } else if (this.state.salonId) {
                await this.initClientApp();
            } else {
                this.initConstructor();
            }
        } catch (e) {
            console.error("Router failed:", e);
            this.utils.showToast("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞.", 'error');
        } finally {
            this.utils.hideLoader();
        }
    },

    utils: {
        showLoader() { App.elements.loader.style.display = 'flex'; },
        hideLoader() {
            App.elements.loader.style.opacity = 0;
            setTimeout(() => {
                App.elements.loader.style.display = 'none';
                App.elements.loader.style.opacity = 1;
            }, 300);
        },
        showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            App.elements.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        },
        getTodayDateString() {
            const today = new Date();
            const offset = today.getTimezoneOffset();
            const localToday = new Date(today.getTime() - (offset * 60 * 1000));
            return localToday.toISOString().split('T')[0];
        },
        formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
        },
        parseDuration(durationStr) { // Parses "1 —á–∞—Å 30 –º–∏–Ω" into 90
            let totalMinutes = 0;
            if (!durationStr || typeof durationStr !== 'string') return 60;
            const hourMatch = durationStr.match(/(\d+)\s*(—á–∞—Å|—á)/);
            const minMatch = durationStr.match(/(\d+)\s*(–º–∏–Ω|–º)/);
            if (hourMatch) totalMinutes += parseInt(hourMatch[1]) * 60;
            if (minMatch) totalMinutes += parseInt(minMatch[1]);
            return totalMinutes || 60; // Default to 60 if parsing fails
        },
        minutesToTime(minutes) {
             const h = Math.floor(minutes / 60).toString().padStart(2, '0');
             const m = (minutes % 60).toString().padStart(2, '0');
             return `${h}:${m}`;
        },
        timeToMinutes(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        },
        validateForm(formId, fields) {
            let isValid = true;
            document.querySelectorAll(`#${formId} .form-error`).forEach(el => el.style.display = 'none');

            for (const field of fields) {
                const input = document.getElementById(field.id);
                const errorEl = document.getElementById(`${field.id}-error`);
                let message = '';

                if (field.required && !input.value.trim()) {
                    message = '–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è';
                } else if (field.type === 'url' && !/^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/i.test(input.value)) {
                    message = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL';
                } else if (field.minLength && input.value.length < field.minLength) {
                    message = `–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: ${field.minLength} —Å–∏–º–≤–æ–ª–æ–≤`;
                }
                
                if (message) {
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                    isValid = false;
                } else {
                    errorEl.style.display = 'none';
                }
            }
            return isValid;
        }
    },

    copyLink(elementId) {
        const linkInput = document.getElementById(elementId);
        linkInput.select();
        document.execCommand('copy');
        this.utils.showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
    },

    // ------------------------------------------------------------------
    // Constructor Mode
    // ------------------------------------------------------------------
    initConstructor() {
        document.getElementById('constructor-wrapper').style.display = 'block';
        document.getElementById('setup-screen').classList.add('active', 'flex');
        document.getElementById('setup-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleGenerateLink();
        });
    },

    async handleGenerateLink() {
        const isValid = this.utils.validateForm('setup-form', [
            { id: 'salon-name-input', required: true },
            { id: 'logo-url-input', required: true, type: 'url' },
            { id: 'salon-admin-password', required: true, minLength: 6 },
        ]);
        if (!isValid) return;

        const name = document.getElementById('salon-name-input').value.trim();
        const logo = document.getElementById('logo-url-input').value.trim();
        const password = document.getElementById('salon-admin-password').value.trim();
        const generateBtn = document.getElementById('generate-link-btn');

        this.utils.showLoader();
        generateBtn.disabled = true;
        try {
            const { data: salonData, error } = await this.supabase
                .from('salons')
                .insert([{ name, logo_url: logo, admin_password: password }])
                .select()
                .single();
            if (error) throw error;
            
            await this.supabase.from('themes').insert([{ salon_id: salonData.id }]);

            const appName = this.tg.initDataUnsafe.web_app.url.split('t.me/')[1].split('/')[0];
            const baseUrl = `https://t.me/${appName}`; 
            document.getElementById('generated-client-link').value = `${baseUrl}?startapp=salonId=${salonData.id}`;
            document.getElementById('generated-admin-link').value = `${baseUrl}?startapp=salonId=${salonData.id}-mode=admin`;
            document.getElementById('setup-form').style.display = 'none';
            document.getElementById('link-result').style.display = 'block';

        } catch (error) {
            console.error("Salon creation failed:", error);
            this.utils.showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∞–ª–æ–Ω–∞: ' + error.message);
        } finally {
            this.utils.hideLoader();
            generateBtn.disabled = false;
        }
    },
    
    // ------------------------------------------------------------------
    // Client App Mode
    // ------------------------------------------------------------------
    async initClientApp() {
        document.getElementById('client-app-wrapper').style.display = 'block';
        this.client.displayUserData();
        
        const { data, error } = await this.supabase.from('salons').select(`*, themes(*)`).eq('id', this.state.salonId).single();
        if (error || !data) {
            this.utils.showToast('–°–∞–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –û—Ç–∫—Ä—ã–≤–∞—é –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä.');
            setTimeout(() => this.initConstructor(), 2000);
            return;
        }
        
        this.state.salonConfig = data;
        this.ui.applyTheme(data.themes[0]);
        await this.client.upsertUser();
        this.client.setupEventListeners();
        
        await this.client.loadData();
        this.client.renderAll();
        
        this.ui.showScreen('home-screen');
    },

    client: {
        displayUserData() {
            const user = App.tg.initDataUnsafe?.user;
            App.state.currentUser = user || { id: 123456789, first_name: '–¢–µ—Å—Ç', username: 'testuser' };
            const userInitial = (App.state.currentUser.first_name || 'U').charAt(0).toUpperCase();
            document.getElementById('profile-name').textContent = App.state.currentUser.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('profile-avatar').src = `https://placehold.co/64x64/fde6ea/c08497?text=${userInitial}`;
        },

        async upsertUser() {
            const { id, first_name, username } = App.state.currentUser;
            if (!id) return;
            await App.supabase.from('users').upsert({ telegram_id: id, first_name, username }, { onConflict: 'telegram_id' });
        },

        setupEventListeners() {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.onclick = () => App.ui.showScreen(btn.dataset.screen);
            });
            App.tg.MainButton.setText('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å').onClick(App.client.handleBookingConfirm);
            App.tg.BackButton.onClick(() => App.ui.goBack());
            
            const datePicker = document.getElementById('date-picker');
            datePicker.min = App.utils.getTodayDateString();
            datePicker.onchange = e => {
                App.state.bookingState.date = e.target.value;
                App.state.bookingState.time = null;
                App.ui.renderTimeSlots();
            };
        },

        async loadData() {
            App.ui.renderSkeletons();
            const { salonId, currentUser } = App.state;
            try {
                const [servicesRes, specialistsRes, postsRes, appointmentsRes] = await Promise.all([
                    App.supabase.from('services').select('*').eq('salon_id', salonId),
                    App.supabase.from('specialists').select('*').eq('salon_id', salonId),
                    App.supabase.from('portfolio_posts').select('*, comments(*, users(first_name))').eq('salon_id', salonId).order('created_at', { ascending: false }),
                    App.supabase.from('appointments').select('*, services(*), specialists(*)').eq('user_telegram_id', currentUser.id).eq('salon_id', salonId).order('date').order('time')
                ]);

                App.state.services = servicesRes.data || [];
                App.state.specialists = specialistsRes.data || [];
                App.state.portfolio = postsRes.data || [];
                App.state.userAppointments = (appointmentsRes.data || []).map(a => ({ ...a, service: a.services, specialist: a.specialists }));
            } catch (error) {
                console.error("Failed to load client data:", error);
                App.utils.showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.");
            }
        },

        renderAll() {
            document.getElementById('salon-name-header').textContent = App.state.salonConfig.name;
            document.getElementById('salon-logo-header').src = App.state.salonConfig.logo_url;
            App.ui.renderServices();
            App.ui.renderAppointments();
            App.ui.renderPortfolio();
        },

        handleServiceSelect(service) {
            App.state.bookingState = { service };
            App.ui.renderSpecialists();
            App.ui.showScreen('specialist-selection-screen');
        },
        
        handleSpecialistSelect(specialist) {
            App.state.bookingState.specialist = specialist;
            const service = App.state.bookingState.service;
            document.getElementById('selected-service-title').textContent = service.name;
            document.getElementById('selected-specialist-subtitle').textContent = `–ú–∞—Å—Ç–µ—Ä: ${specialist.name}„Éª${service.duration}`;

            const datePicker = document.getElementById('date-picker');
            datePicker.value = App.utils.getTodayDateString();
            App.state.bookingState.date = datePicker.value;
            
            App.ui.renderTimeSlots();
            App.ui.showScreen('booking-screen');
        },
        
        handleTimeSelect(el, time) {
            if (el.classList.contains('disabled')) return;
            document.querySelectorAll('#time-slots-container .time-slot').forEach(s => s.classList.remove('selected'));
            el.classList.add('selected');
            App.state.bookingState.time = time;
            App.client.updateConfirmButtonState();
        },

        updateConfirmButtonState() {
            const { service, specialist, date, time } = App.state.bookingState;
            const isActive = !!(service && specialist && date && time);
            if (App.tg.MainButton.isVisible) {
                App.tg.MainButton.setParams({ is_active: isActive });
            }
        },

        async handleBookingConfirm() {
            if (!App.tg.MainButton.isActive) return;
            App.utils.showLoader();
            const { service, specialist, date, time } = App.state.bookingState;
            try {
                const { error } = await App.supabase.from('appointments').insert([{
                    salon_id: App.state.salonId,
                    user_telegram_id: App.state.currentUser.id,
                    service_id: service.id,
                    specialist_id: specialist.id,
                    date: date,
                    time: time
                }]);
                if (error) throw error;
                
                document.getElementById('success-details').textContent = `–ñ–¥–µ–º –≤–∞—Å ${App.utils.formatDate(date)} –≤ ${time} –Ω–∞ —É—Å–ª—É–≥—É "${service.name}".`;
                App.ui.showScreen('success-screen');
                await App.client.loadData();
                App.ui.renderAppointments();

            } catch (error) {
                console.error("Booking failed:", error);
                App.utils.showToast('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ' + error.message);
            } finally {
                App.utils.hideLoader();
            }
        },

        handleAppointmentCancel(appointmentId) {
             App.ui.showModal({
                title: '–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?',
                content: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.',
                buttons: [
                    { text: '–û—Å—Ç–∞–≤–∏—Ç—å', role: 'secondary', action: App.ui.hideModal },
                    { text: '–û—Ç–º–µ–Ω–∏—Ç—å', role: 'danger', action: async () => {
                        App.ui.hideModal();
                        App.utils.showLoader();
                        try {
                            const { error } = await App.supabase.from('appointments').delete().eq('id', appointmentId);
                            if (error) throw error;
                            App.utils.showToast('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–∞');
                            await App.client.loadData();
                            App.ui.renderAppointments();
                        } catch (error) {
                            console.error("Cancellation failed:", error);
                            App.utils.showToast('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã: ' + error.message);
                        } finally {
                            App.utils.hideLoader();
                        }
                    }}
                ]
            });
        },
        
        async handlePostComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const text = input.value.trim();
            if (!text) return;
            
            App.utils.showLoader();
            try {
                const { data: commentData, error } = await App.supabase.from('comments').insert({
                    post_id: postId,
                    user_telegram_id: App.state.currentUser.id,
                    text: text
                }).select().single();
                if (error) throw error;
                input.value = '';

                // Optimistic update: add comment to UI without full reload
                const post = App.state.portfolio.find(p => p.id === postId);
                if (post) {
                    post.comments.push({ ...commentData, users: { first_name: App.state.currentUser.first_name } });
                    App.ui.renderPostDetail(post);
                }
            } catch (error) {
                console.error("Comment failed:", error);
                App.utils.showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.');
            } finally {
                App.utils.hideLoader();
            }
        }
    },

    ui: {
        applyTheme(theme) {
            const root = document.documentElement;
            if (!theme) return;
            const updateVar = (name, value, fallback) => root.style.setProperty(name, value || fallback);
            updateVar('--bg-color', theme.bg_color, '#f8fafc');
            updateVar('--text-color', theme.text_color, '#334155');
            updateVar('--button-color', theme.button_color, '#c08497');
            updateVar('--button-text-color', theme.button_text_color, '#ffffff');
            updateVar('--secondary-bg-color', theme.secondary_bg_color, '#ffffff');
            
            App.tg.setHeaderColor(theme.secondary_bg_color || '#ffffff');
        },

        showScreen(screenId, isBack = false) {
            if (!isBack && App.state.screenHistory[App.state.screenHistory.length - 1] !== screenId) {
                App.state.screenHistory.push(screenId);
            }
            document.querySelectorAll('#client-app-wrapper .screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            const isBaseScreen = ['home-screen', 'services-screen', 'my-appointments-screen', 'profile-screen'].includes(screenId);
            App.tg.BackButton.setVisible(App.state.screenHistory.length > 1);
            App.tg.MainButton.setVisible(screenId === 'booking-screen');
            document.getElementById('client-header').style.display = isBaseScreen ? 'flex' : 'none';

            if (screenId === 'booking-screen') App.client.updateConfirmButtonState();
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.screen === screenId || (screenId.includes('booking') && item.dataset.screen === 'services-screen')));
            window.scrollTo(0, 0);
        },

        goBack() {
            if (App.state.screenHistory.length > 1) {
                App.state.screenHistory.pop();
                App.ui.showScreen(App.state.screenHistory[App.state.screenHistory.length - 1], true);
            }
        },

        showModal({ title, content, buttons }) {
            const modalHTML = `
                <div class="modal-content">
                    <h2 class="text-lg font-bold mb-2">${title}</h2>
                    <p class="text-slate-600 mb-6">${content}</p>
                    <div class="flex gap-3 justify-center">
                        ${buttons.map((btn, index) => {
                            const roleClass = btn.role === 'danger' ? 'bg-red-500 text-white' : (btn.role === 'secondary' ? 'bg-slate-200 text-slate-800' : 'btn-primary');
                            return `<button id="modal-btn-${index}" class="btn w-full ${roleClass}">${btn.text}</button>`;
                        }).join('')}
                    </div>
                </div>`;
            App.elements.modalContainer.innerHTML = modalHTML;
            buttons.forEach((btn, index) => {
                document.getElementById(`modal-btn-${index}`).onclick = btn.action;
            });
            App.elements.modalContainer.classList.add('active');
        },

        hideModal() {
            App.elements.modalContainer.classList.remove('active');
        },

        renderSkeletons() {
            const skeletonPost = `<div class="card skeleton"><div class="p-4 flex items-center"><div class="w-8 h-8 rounded-full bg-slate-200 mr-3"></div><div class="h-4 bg-slate-200 rounded w-1/3"></div></div><div class="w-full h-64 bg-slate-200"></div><div class="p-4"><div class="h-4 bg-slate-200 rounded w-full"></div></div></div>`;
            const skeletonCard = `<div class="skeleton-card flex justify-between items-center skeleton"><div><div class="h-5 bg-slate-200 rounded w-32 mb-2"></div><div class="h-4 bg-slate-200 rounded w-24"></div></div><div class="h-9 w-20 bg-slate-200 rounded-lg"></div></div>`;
            
            document.getElementById('portfolio-posts').innerHTML = Array(2).fill(skeletonPost).join('');
            document.getElementById('services-list').innerHTML = Array(4).fill(skeletonCard).join('');
            document.getElementById('specialists-list').innerHTML = Array(3).fill(skeletonCard).join('');
        },

        renderEmptyState(container, message, buttonText, action) {
            container.innerHTML = `<div class="text-center text-slate-500 py-10 px-4"><p class="mb-4">${message}</p>${buttonText ? `<button onclick="${action}" class="btn btn-primary">${buttonText}</button>` : ''}</div>`;
        },

        renderServices() {
            const list = document.getElementById('services-list');
            if (App.state.services.length === 0) {
                this.renderEmptyState(list, '–í —ç—Ç–æ–º —Å–∞–ª–æ–Ω–µ –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥.');
                return;
            }
            list.innerHTML = App.state.services.map(s => `
                <div class="card p-4 flex justify-between items-center">
                    <div>
                        <h2 class="font-semibold">${s.name}</h2>
                        <p class="text-sm text-slate-500" style="color: var(--hint-color);">${s.duration} / ${s.price} ‚ÇΩ</p>
                    </div>
                    <button onclick='App.client.handleServiceSelect(${JSON.stringify(s)})' class="btn btn-primary text-sm">–í—ã–±—Ä–∞—Ç—å</button>
                </div>
            `).join('');
        },
        
        renderSpecialists() {
            const list = document.getElementById('specialists-list');
            const { specialists } = App.state;
            if (specialists.length === 0) {
                this.renderEmptyState(list, '–ú–∞—Å—Ç–µ—Ä–∞ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.');
                return;
            }
            list.innerHTML = specialists.map(s => `
                <div class="card p-4 flex justify-between items-center">
                    <div class="flex items-center">
                        <img src="${s.photo_url}" class="w-12 h-12 rounded-full object-cover mr-4">
                        <div>
                            <h2 class="font-semibold">${s.name}</h2>
                            <p class="text-sm text-slate-500" style="color: var(--hint-color);">${s.specialty}</p>
                        </div>
                    </div>
                    <button onclick='App.client.handleSpecialistSelect(${JSON.stringify(s)})' class="btn btn-primary text-sm">–í—ã–±—Ä–∞—Ç—å</button>
                </div>
            `).join('');
        },

        renderPortfolio() {
            const container = document.getElementById('portfolio-posts');
            if (App.state.portfolio.length === 0) {
                this.renderEmptyState(container, '–í –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –ø–æ–∫–∞ –Ω–µ—Ç —Ä–∞–±–æ—Ç.');
                return;
            }
            container.innerHTML = App.state.portfolio.map(post => `
                <div class="card cursor-pointer" onclick='App.ui.renderPostDetail(${JSON.stringify(post)})'>
                    <div class="p-4 flex items-center">
                        <img src="${App.state.salonConfig.logo_url}" class="w-8 h-8 rounded-full mr-3 object-cover">
                        <span class="font-semibold">${App.state.salonConfig.name}</span>
                    </div>
                    <img src="${post.img_url}" alt="${post.title}" class="w-full h-auto max-h-96 object-cover">
                    <div class="p-4">
                        <p><span class="font-semibold">${App.state.salonConfig.name}</span> ${post.description || ''}</p>
                        <p class="text-xs text-slate-400 mt-2" style="color: var(--hint-color);">${post.comments.length} –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>
                    </div>
                </div>`).join('');
        },
        
        renderPostDetail(post) {
            const container = document.getElementById('post-view-screen');
            const commentsHtml = post.comments.map(c => `<div class="mb-2"><span class="font-semibold">${c.users.first_name}:</span> ${c.text}</div>`).join('');
            
            container.innerHTML = `
                <div class="p-4">
                    <div class="card">
                        <div class="p-4 flex items-center"><img src="${App.state.salonConfig.logo_url}" class="w-8 h-8 rounded-full mr-3 object-cover"><span class="font-semibold">${App.state.salonConfig.name}</span></div>
                        <img src="${post.img_url}" class="w-full h-auto">
                        <div class="p-4">
                            <p class="font-semibold mb-2">${post.title}</p>
                            <p>${post.description || ''}</p>
                        </div>
                    </div>
                    <div class="card mt-4 p-4">
                        <h3 class="font-semibold mb-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
                        <div class="text-sm space-y-2 mb-4">${commentsHtml || '<p class="text-slate-400">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>'}</div>
                        <form onsubmit="event.preventDefault(); App.client.handlePostComment(${post.id})">
                            <div class="flex space-x-2">
                                <input id="comment-input-${post.id}" type="text" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." class="w-full p-2 border rounded-lg" required>
                                <button type="submit" class="btn btn-primary px-4">‚úì</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            this.showScreen('post-view-screen');
        },

        async renderTimeSlots() {
            const container = document.getElementById('time-slots-container');
            container.innerHTML = `<div class="col-span-full flex justify-center py-4"><div class="spinner !w-6 !h-6"></div></div>`;
            App.tg.MainButton.setParams({ is_active: false });

            const { date, specialist, service } = App.state.bookingState;
            const { work_start, work_end, lunch_start, lunch_end } = App.state.salonConfig;
            
            const serviceDuration = App.utils.parseDuration(service.duration);
            const workStartMins = App.utils.timeToMinutes(work_start || '10:00');
            const workEndMins = App.utils.timeToMinutes(work_end || '19:00');
            const lunchStartMins = App.utils.timeToMinutes(lunch_start || '13:00');
            const lunchEndMins = App.utils.timeToMinutes(lunch_end || '14:00');

            const { data } = await App.supabase.from('appointments').select('time, services(duration)').eq('salon_id', App.state.salonId).eq('date', date).eq('specialist_id', specialist.id);
            const busySlots = (data || []).map(d => {
                const start = App.utils.timeToMinutes(d.time);
                const duration = App.utils.parseDuration(d.services.duration);
                return { start, end: start + duration };
            });

            let slots = '';
            // –ò—Ç–µ—Ä–∞—Ü–∏—è —Å —à–∞–≥–æ–º 15 –º–∏–Ω—É—Ç –¥–ª—è –±–æ–ª—å—à–µ–π –≥–∏–±–∫–æ—Å—Ç–∏
            for (let t = workStartMins; t <= workEndMins - serviceDuration; t += 15) {
                const slotStart = t;
                const slotEnd = t + serviceDuration;
                let isAvailable = true;

                // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å –æ–±–µ–¥–æ–º
                if (Math.max(slotStart, lunchStartMins) < Math.min(slotEnd, lunchEndMins)) {
                    isAvailable = false;
                }

                // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏
                if (isAvailable) {
                    for (const busy of busySlots) {
                        if (Math.max(slotStart, busy.start) < Math.min(slotEnd, busy.end)) {
                            isAvailable = false;
                            break;
                        }
                    }
                }
                
                // 3. –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è, –ø—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –ø—Ä–æ—à–µ–ª –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —Å–ª–æ—Ç
                const now = new Date();
                const selectedDate = new Date(date + 'T00:00:00');
                if (selectedDate.toDateString() === now.toDateString()) {
                    const currentMins = now.getHours() * 60 + now.getMinutes();
                    if (slotStart <= currentMins) {
                        isAvailable = false;
                    }
                }

                if (isAvailable) {
                    const time = App.utils.minutesToTime(slotStart);
                    slots += `<div onclick="App.client.handleTimeSelect(this, '${time}')" class="time-slot p-2 rounded-lg">${time}</div>`;
                }
            }
            container.innerHTML = slots || '<div class="col-span-full text-center text-slate-500 py-4">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É.</div>';
        },

        renderAppointments() {
            const container = document.getElementById('appointments-list');
            if (App.state.userAppointments.length === 0) {
                this.renderEmptyState(container, '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π. üóìÔ∏è', '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è', 'App.ui.showScreen("services-screen")');
                return;
            }

            const now = new Date();
            const upcoming = App.state.userAppointments.filter(a => new Date(a.date + 'T' + a.time) >= now).sort((a,b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
            const past = App.state.userAppointments.filter(a => new Date(a.date + 'T' + a.time) < now).sort((a,b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));

            const renderList = (title, list, showCancel) => {
                if(list.length === 0) return '';
                return `
                    <h2 class="font-bold text-lg mb-3">${title}</h2>
                    <div class="space-y-3 mb-6">
                    ${list.map(a => `
                        <div class="card p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold">${a.service.name}</h3>
                                    <p class="text-sm text-slate-500" style="color: var(--hint-color);">–ú–∞—Å—Ç–µ—Ä: ${a.specialist.name}</p>
                                    <p class="text-sm font-semibold mt-1">${App.utils.formatDate(a.date)} –≤ ${a.time}</p>
                                </div>
                                ${showCancel ? `<button onclick="App.client.handleAppointmentCancel(${a.id})" class="text-xs text-red-500 font-semibold p-1">–û—Ç–º–µ–Ω–∏—Ç—å</button>` : ''}
                            </div>
                        </div>`).join('')}
                    </div>
                `;
            };
            
            container.innerHTML = renderList('–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ', upcoming, true) + renderList('–ü—Ä–æ—à–µ–¥—à–∏–µ', past, false);
        }
    },

    // ------------------------------------------------------------------
    // Admin Mode
    // ------------------------------------------------------------------
    initAdmin() {
        document.getElementById('admin-mode-wrapper').style.display = 'block';
        if (sessionStorage.getItem('admin_logged_in_' + this.state.salonId)) {
            this.admin.showPanel();
        } else {
            document.getElementById('admin-login-screen').style.display = 'block';
            document.getElementById('admin-login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                this.admin.handleLogin();
            });
        }
    },

    admin: {
        async handleLogin() {
            App.utils.showLoader();
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';
            
            try {
                const { data, error } = await App.supabase.from('salons').select('admin_password').eq('id', App.state.salonId).single();
                if (error || !data) throw new Error('–°–∞–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.');
                if (data.admin_password === password) {
                    sessionStorage.setItem('admin_logged_in_' + App.state.salonId, 'true');
                    await App.admin.showPanel();
                } else {
                    errorEl.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.';
                }
            } catch (e) {
                errorEl.textContent = e.message;
            } finally {
                App.utils.hideLoader();
            }
        },

        handleLogout() {
            sessionStorage.removeItem('admin_logged_in_' + App.state.salonId);
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('login-error').textContent = '';
            document.getElementById('password-input').value = '';
            document.getElementById('admin-login-screen').style.display = 'block';
        },
        
        async showPanel() {
            document.getElementById('admin-login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('logout-btn').onclick = () => this.handleLogout();

            App.utils.showLoader();
            await this.loadData();
            this.setupNav();
            this.renderCurrentPanel();
            App.utils.hideLoader();
        },

        setupNav() {
            const navContainer = document.getElementById('admin-nav');
            navContainer.querySelectorAll('.admin-nav-item').forEach(btn => {
                btn.onclick = () => {
                    App.state.currentAdminPanel = btn.dataset.panel;
                    this.renderCurrentPanel();
                };
            });
        },
        
        renderCurrentPanel() {
             document.querySelectorAll('.admin-nav-item').forEach(btn => {
                 btn.classList.toggle('active', btn.dataset.panel === App.state.currentAdminPanel);
             });
             document.querySelectorAll('.admin-panel-content').forEach(p => p.style.display = 'none');
            
            const panelId = `admin-panel-${App.state.currentAdminPanel}`;
            const panel = document.getElementById(panelId);
            panel.style.display = 'block';
            
            switch(App.state.currentAdminPanel) {
                case 'appointments': this.render.appointments(panel); break;
                case 'services': this.render.services(panel); break;
                case 'specialists': this.render.specialists(panel); break;
                case 'portfolio': this.render.portfolio(panel); break;
                case 'theme': this.render.theme(panel); break;
                case 'settings': this.render.settings(panel); break;
            }
        },

        async loadData() {
            const { data, error } = await App.supabase.from('salons').select(`*, themes(*), services(*), specialists(*), portfolio_posts(*)`).eq('id', App.state.salonId).single();
            if (error) { App.utils.showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–∞–ª–æ–Ω–∞.'); return; }
            App.state.salonConfig = data;
            
            const { data: appointments, error: apptError } = await App.supabase
                .from('appointments')
                .select('*, services(name), specialists(name), users(first_name)')
                .eq('salon_id', App.state.salonId)
                .order('date', { ascending: true })
                .order('time', { ascending: true });
            if(apptError){ App.utils.showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–ø–∏—Å–∏.'); return; }
            
            App.state.allAppointments = appointments || [];
            document.getElementById('admin-salon-name').textContent = App.state.salonConfig.name;
        },

        render: {
            appointments(container) {
                const now = new Date();
                const upcoming = App.state.allAppointments.filter(a => new Date(a.date + 'T' + a.time) >= now);
                if (upcoming.length === 0) {
                    container.innerHTML = `<div class="admin-card text-center text-slate-500">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç.</div>`;
                    return;
                }
                const appointmentsByDate = upcoming.reduce((acc, curr) => {
                    (acc[curr.date] = acc[curr.date] || []).push(curr);
                    return acc;
                }, {});

                container.innerHTML = Object.entries(appointmentsByDate).map(([date, appts]) => `
                    <div class="admin-card">
                        <h3 class="font-bold mb-4">${App.utils.formatDate(date)}</h3>
                        <div class="space-y-3">
                            ${appts.map(a => `
                                <div class="p-3 border rounded-md bg-slate-50">
                                    <p class="font-semibold">${a.time} - ${a.services?.name || '–£–¥–∞–ª–µ–Ω–Ω–∞—è —É—Å–ª—É–≥–∞'}</p>
                                    <p class="text-sm text-slate-600">–ö–ª–∏–µ–Ω—Ç: ${a.users?.first_name || 'N/A'}</p>
                                    <p class="text-sm text-slate-600">–ú–∞—Å—Ç–µ—Ä: ${a.specialists?.name || '–£–¥–∞–ª–µ–Ω–Ω—ã–π –º–∞—Å—Ç–µ—Ä'}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>`).join('');
            },
            
            services(container) {
                container.innerHTML = `
                    <div class="admin-card">
                        <h2 class="text-xl font-semibold mb-4">–£—Å–ª—É–≥–∏</h2>
                        <div id="admin-services-list" class="space-y-2 mb-4">
                        ${(App.state.salonConfig.services || []).map(s => `
                            <div id="item-services-${s.id}" class="flex justify-between items-center p-2 border rounded-md">
                                <span>${s.name} (${s.duration}) - ${s.price} ‚ÇΩ</span>
                                <button onclick="App.admin.actions.deleteItem('services', ${s.id})" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">&times;</button>
                            </div>`).join('') || '<p class="text-slate-500">–ù–µ—Ç —É—Å–ª—É–≥.</p>'}
                        </div>
                    </div>
                    <form id="add-service-form" class="admin-card">
                        <h3 class="font-semibold mb-2">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input id="new-service-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="admin-input" required>
                            <input id="new-service-price" placeholder="–¶–µ–Ω–∞ (—á–∏—Å–ª–æ)" type="number" class="admin-input" required>
                            <input id="new-service-duration" placeholder="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–Ω–∞–ø—Ä. 1 —á–∞—Å 30 –º–∏–Ω)" class="admin-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary mt-4 bg-pink-600 hover:bg-pink-700">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </form>`;
                document.getElementById('add-service-form').onsubmit = e => { e.preventDefault(); App.admin.actions.addService(); };
            },
            
            specialists(container){
                container.innerHTML = `
                    <div class="admin-card">
                        <h2 class="text-xl font-semibold mb-4">–ú–∞—Å—Ç–µ—Ä–∞</h2>
                        <div id="admin-specialists-list" class="space-y-2 mb-4">
                         ${(App.state.salonConfig.specialists || []).map(s => `
                            <div id="item-specialists-${s.id}" class="flex justify-between items-center p-2 border rounded-md">
                                <div class="flex items-center gap-3">
                                  <img src="${s.photo_url}" class="w-10 h-10 rounded-full object-cover"/>
                                  <span>${s.name} - ${s.specialty}</span>
                                </div>
                                <button onclick="App.admin.actions.deleteItem('specialists', ${s.id})" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">&times;</button>
                            </div>`).join('') || '<p class="text-slate-500">–ù–µ—Ç –º–∞—Å—Ç–µ—Ä–æ–≤.</p>'}
                        </div>
                    </div>
                    <form id="add-specialist-form" class="admin-card">
                        <h3 class="font-semibold mb-2">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞</h3>
                        <div class="space-y-4">
                            <input id="new-specialist-name" placeholder="–ò–º—è" class="admin-input" required>
                            <input id="new-specialist-specialty" placeholder="–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å (–Ω–∞–ø—Ä. –ú–∞—Å—Ç–µ—Ä –º–∞–Ω–∏–∫—é—Ä–∞)" class="admin-input" required>
                            <input id="new-specialist-photo" placeholder="URL —Ñ–æ—Ç–æ" type="url" class="admin-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary mt-4 bg-pink-600 hover:bg-pink-700">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </form>`;
                document.getElementById('add-specialist-form').onsubmit = e => { e.preventDefault(); App.admin.actions.addSpecialist(); };
            },
            
            portfolio(container){
                container.innerHTML = `
                    <div class="admin-card">
                        <h2 class="text-xl font-semibold mb-4">–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</h2>
                        <div id="admin-portfolio-list" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                         ${(App.state.salonConfig.portfolio_posts || []).map(p => `
                            <div id="item-portfolio_posts-${p.id}" class="relative">
                                <img src="${p.img_url}" class="w-full h-32 object-cover rounded-md"/>
                                <p class="text-xs mt-1 truncate" title="${p.title}">${p.title}</p>
                                <button onclick="App.admin.actions.deleteItem('portfolio_posts', ${p.id})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center font-bold text-xs">&times;</button>
                            </div>`).join('') || '<p class="text-slate-500 col-span-full">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤.</p>'}
                        </div>
                    </div>
                    <form id="add-post-form" class="admin-card">
                        <h3 class="font-semibold mb-2">–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç</h3>
                        <div class="space-y-4">
                            <input id="new-post-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" class="admin-input" required>
                            <input id="new-post-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" class="admin-input">
                            <input id="new-post-img" placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" type="url" class="admin-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary mt-4 bg-pink-600 hover:bg-pink-700">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </form>`;
                document.getElementById('add-post-form').onsubmit = e => { e.preventDefault(); App.admin.actions.addPortfolioPost(); };
            },
            
            theme(container) {
                const theme = App.state.salonConfig.themes[0] || {};
                container.innerHTML = `
                    <div class="admin-card">
                        <h2 class="text-xl font-semibold mb-4">–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label class="block text-sm font-medium">–ö–Ω–æ–ø–∫–∏</label><input type="color" id="theme-button-color" value="${theme.button_color || '#c08497'}" class="w-full h-10 cursor-pointer p-1 border border-slate-200 rounded"></div>
                            <div><label class="block text-sm font-medium">–¢–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö</label><input type="color" id="theme-button-text-color" value="${theme.button_text_color || '#ffffff'}" class="w-full h-10 cursor-pointer p-1 border border-slate-200 rounded"></div>
                            <div><label class="block text-sm font-medium">–§–æ–Ω</label><input type="color" id="theme-bg-color" value="${theme.bg_color || '#f8fafc'}" class="w-full h-10 cursor-pointer p-1 border border-slate-200 rounded"></div>
                            <div><label class="block text-sm font-medium">–¢–µ–∫—Å—Ç</label><input type="color" id="theme-text-color" value="${theme.text_color || '#334155'}" class="w-full h-10 cursor-pointer p-1 border border-slate-200 rounded"></div>
                        </div>
                        <button onclick="App.admin.actions.saveTheme()" class="btn btn-primary mt-4 bg-pink-600 hover:bg-pink-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–º—É</button>
                    </div>`;
            },

            settings(container) {
                const config = App.state.salonConfig;
                container.innerHTML = `
                     <div class="admin-card">
                        <h2 class="text-xl font-semibold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</h2>
                        <div class="grid grid-cols-2 gap-4">
                           <div>
                              <label class="block text-sm font-medium mb-1">–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è</label>
                              <input type="time" id="settings-work-start" value="${config.work_start || '10:00'}" class="admin-input">
                           </div>
                           <div>
                              <label class="block text-sm font-medium mb-1">–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è</label>
                              <input type="time" id="settings-work-end" value="${config.work_end || '19:00'}" class="admin-input">
                           </div>
                           <div>
                              <label class="block text-sm font-medium mb-1">–ù–∞—á–∞–ª–æ –æ–±–µ–¥–∞</label>
                              <input type="time" id="settings-lunch-start" value="${config.lunch_start || '13:00'}" class="admin-input">
                           </div>
                           <div>
                              <label class="block text-sm font-medium mb-1">–ö–æ–Ω–µ—Ü –æ–±–µ–¥–∞</label>
                              <input type="time" id="settings-lunch-end" value="${config.lunch_end || '14:00'}" class="admin-input">
                           </div>
                        </div>
                        <button onclick="App.admin.actions.saveSettings()" class="btn btn-primary mt-4 bg-pink-600 hover:bg-pink-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                     </div>`;
            }
        },

        actions: {
            async _refreshDataAndRender() {
                App.utils.showLoader();
                await App.admin.loadData();
                App.admin.renderCurrentPanel();
                App.utils.hideLoader();
            },

            async addService() {
                const nameInput = document.getElementById('new-service-name');
                const priceInput = document.getElementById('new-service-price');
                const durationInput = document.getElementById('new-service-duration');
                
                if (!nameInput.value || !priceInput.value || !durationInput.value) { App.utils.showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.'); return; }
                
                const { error } = await App.supabase.from('services').insert([{ salon_id: App.state.salonId, name: nameInput.value, price: priceInput.value, duration: durationInput.value }]);
                if (error) App.utils.showToast('–û—à–∏–±–∫–∞: ' + error.message);
                else {
                    App.utils.showToast('–£—Å–ª—É–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                    await this._refreshDataAndRender();
                }
            },
            
            async addSpecialist() {
                const name = document.getElementById('new-specialist-name').value.trim();
                const specialty = document.getElementById('new-specialist-specialty').value.trim();
                const photo_url = document.getElementById('new-specialist-photo').value.trim();
                if (!name || !specialty || !photo_url) { App.utils.showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.'); return; }

                const { error } = await App.supabase.from('specialists').insert([{ salon_id: App.state.salonId, name, specialty, photo_url }]);
                if (error) App.utils.showToast('–û—à–∏–±–∫–∞: ' + error.message);
                else {
                    App.utils.showToast('–ú–∞—Å—Ç–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω!');
                    await this._refreshDataAndRender();
                }
            },

            async addPortfolioPost() {
                const title = document.getElementById('new-post-title').value.trim();
                const description = document.getElementById('new-post-desc').value.trim();
                const img_url = document.getElementById('new-post-img').value.trim();
                if (!title || !img_url) { App.utils.showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ URL.'); return; }

                const { error } = await App.supabase.from('portfolio_posts').insert([{ salon_id: App.state.salonId, title, description, img_url }]);
                if (error) App.utils.showToast('–û—à–∏–±–∫–∞: ' + error.message);
                else {
                    App.utils.showToast('–ü–æ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
                    await this._refreshDataAndRender();
                }
            },

            async deleteItem(tableName, itemId) {
                App.ui.showModal({
                    title: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ',
                    content: '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.',
                    buttons: [
                        { text: '–û—Ç–º–µ–Ω–∞', role: 'secondary', action: App.ui.hideModal },
                        { text: '–£–¥–∞–ª–∏—Ç—å', role: 'danger', action: async () => {
                            App.ui.hideModal();
                            const itemEl = document.getElementById(`item-${tableName}-${itemId}`);
                            if (itemEl) itemEl.style.opacity = '0.5';

                            const { error } = await App.supabase.from(tableName).delete().eq('id', itemId);
                            if (error) {
                                App.utils.showToast('–û—à–∏–±–∫–∞: ' + error.message);
                                if (itemEl) itemEl.style.opacity = '1';
                            } else {
                                App.utils.showToast('–£–¥–∞–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
                                await this._refreshDataAndRender();
                            }
                        }}
                    ]
                });
            },

            async saveTheme() {
                const themeData = {
                    salon_id: App.state.salonId,
                    button_color: document.getElementById('theme-button-color').value,
                    button_text_color: document.getElementById('theme-button-text-color').value,
                    bg_color: document.getElementById('theme-bg-color').value,
                    text_color: document.getElementById('theme-text-color').value
                };
                const { error } = await App.supabase.from('themes').upsert(themeData, { onConflict: 'salon_id' });
                if (error) App.utils.showToast('–û—à–∏–±–∫–∞: ' + error.message);
                else App.utils.showToast('–¢–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
            },

            async saveSettings() {
                const settings = {
                    work_start: document.getElementById('settings-work-start').value,
                    work_end: document.getElementById('settings-work-end').value,
                    lunch_start: document.getElementById('settings-lunch-start').value,
                    lunch_end: document.getElementById('settings-lunch-end').value,
                };
                const { error } = await App.supabase.from('salons').update(settings).eq('id', App.state.salonId);
                if (error) App.utils.showToast('–û—à–∏–±–∫–∞: ' + error.message);
                else App.utils.showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            }
        }
    }
};

document.addEventListener('DOMContentLoaded', () => App.init());

</script>
</body>
</html>
