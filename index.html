<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Салон Красоты</title>
    <!-- Telegram Web App script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc;
            --text-color: #334155;
            --button-color: #c08497;
            --button-text-color: #ffffff;
            --hint-color: #94a3b8;
            --secondary-bg-color: #ffffff;
            --header-bg-color: #ffffff;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .main-container { padding-bottom: 80px; }
        .btn-primary { background-color: var(--button-color); color: var(--button-text-color); font-weight: 600; border-radius: 0.75rem; padding: 0.65rem 1.5rem; transition: background-color: 0.3s; }
        .btn-primary:hover { opacity: 0.9; }
        .card { background-color: var(--secondary-bg-color); border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07); margin-bottom: 1rem; }
        .screen { display: none; }
        .screen.active { display: block; }
        .time-slot { cursor: pointer; border: 1px solid #e2e8f0; transition: all 0.2s; }
        .time-slot.selected { background-color: var(--button-color); color: var(--button-text-color); border-color: var(--button-color); }
        .time-slot:not(.disabled):hover { background-color: #fde6ea; border-color: #fde6ea; }
        .time-slot.disabled { background-color: #f1f5f9; color: var(--hint-color); cursor: not-allowed; }
        .nav-item { color: var(--hint-color); transition: all 0.2s; }
        .nav-item.active { color: var(--button-color); background-color: #fde6ea; }
        .nav-item.active svg { color: var(--button-color); }
        .stories-container { -ms-overflow-style: none; scrollbar-width: none; }
        .stories-container::-webkit-scrollbar { display: none; }
        .story-item { border: 2px solid var(--button-color); }
        .modal { display: none; transition: opacity 0.3s ease; }
        .modal.show { display: flex; }
        .like-btn.liked svg { fill: #ef4444; stroke: #ef4444; }
        #post-view-screen.active { height: 100vh; display: flex; flex-direction: column; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--button-color); animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased text-sm">

    <div id="loader"><div class="spinner"></div></div>

    <div id="setup-screen" class="screen p-6 min-h-screen flex-col justify-center items-center">
        <div class="w-full max-w-md text-center">
            <div class="bg-rose-100 p-3 rounded-full inline-block mb-4" style="background-color: var(--button-color); opacity: 0.2;">
                <svg class="w-8 h-8 text-rose-500" style="color: var(--button-color);" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 12.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0Z"/><path d="M12 12.5V18a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2.2c0-.8-.4-1.5-.9-2-.4-.4-1-.7-1.6-.9-.7-.2-1.3-.5-1.9-1-.6-.4-1.2-1-1.6-1.6a2.5 2.5 0 0 0-4 0c-.5.7-1 1.2-1.6 1.6-.6.4-1.2.7-1.9 1-.6.2-1.2.5-1.6.9-.5.5-.9 1.2-.9 2V20a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-5.5"/></svg>
            </div>
            <h1 class="text-2xl font-bold mb-2" style="color: var(--text-color);">Создайте свой салон</h1>
            <p class="text-slate-500 mb-8" style="color: var(--hint-color);">Введите название и логотип, чтобы получить уникальную ссылку на ваше приложение.</p>
            <div class="card p-6 text-left !mb-6">
                <div class="mb-4">
                    <label for="salon-name-input" class="block font-semibold mb-2">Название салона</label>
                    <input type="text" id="salon-name-input" placeholder="Например, Beauty Haven" class="w-full p-3 border rounded-lg focus:ring-rose-400 focus:border-rose-400" style="background-color: var(--secondary-bg-color); color: var(--text-color);">
                </div>
                <div class="mb-6">
                    <label for="logo-url-input" class="block font-semibold mb-2">URL логотипа</label>
                    <input type="url" id="logo-url-input" placeholder="https://example.com/logo.png" class="w-full p-3 border rounded-lg focus:ring-rose-400 focus:border-rose-400" style="background-color: var(--secondary-bg-color); color: var(--text-color);">
                </div>
                <button id="generate-link-btn" class="btn-primary w-full py-3">Создать ссылку</button>
            </div>
            <div id="link-result" class="text-left" style="display: none;">
                 <div class="card p-4">
                    <label class="block font-semibold mb-2 text-sm">Ваша уникальная ссылка:</label>
                    <div class="flex space-x-2">
                        <input type="text" id="generated-link-input" readonly class="w-full p-2 border rounded-lg bg-slate-100 text-slate-600 text-xs" style="background-color: var(--bg-color); color: var(--text-color);">
                        <button id="copy-link-btn" class="btn-primary text-sm px-4">Копировать</button>
                    </div>
                    <p id="copy-feedback" class="text-green-600 text-xs mt-2 text-center" style="display: none;">Скопировано!</p>
                 </div>
            </div>
        </div>
    </div>

    <div id="app-wrapper" style="display: none;">
        <div id="app" class="main-container min-h-screen">
            <div id="home-screen" class="screen">
                <header class="flex items-center p-4 pt-6 bg-white shadow-sm" style="background-color: var(--header-bg-color);">
                    <div id="salon-logo-container" class="w-10 h-10 flex items-center justify-center bg-rose-100 p-2 rounded-full" style="background-color: var(--button-color); opacity: 0.2;">
                         <svg class="w-6 h-6 text-rose-500" style="color: var(--button-color);" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 12.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0Z"/><path d="M12 12.5V18a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2.2c0-.8-.4-1.5-.9-2-.4-.4-1-.7-1.6-.9-.7-.2-1.3-.5-1.9-1-.6-.4-1.2-1-1.6-1.6a2.5 2.5 0 0 0-4 0c-.5.7-1 1.2-1.6 1.6-.6.4-1.2.7-1.9 1-.6.2-1.2.5-1.6.9-.5.5-.9 1.2-.9 2V20a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-5.5"/></svg>
                    </div>
                    <h1 id="salon-name-header" class="text-xl font-bold text-slate-800 ml-3" style="color: var(--text-color);">Beauty Haven</h1>
                </header>
                <div id="stories-list" class="stories-container flex space-x-4 overflow-x-auto p-4 bg-white" style="background-color: var(--secondary-bg-color);"></div>
                <div id="portfolio-posts" class="space-y-1 bg-slate-100 pt-1" style="background-color: var(--bg-color);"></div>
            </div>
            <div id="post-view-screen" class="screen"></div>
            <div id="services-screen" class="screen p-4">
                <header class="mb-5"><h1 class="text-xl font-bold">Выберите услугу</h1></header>
                <div id="services-list" class="space-y-3"></div>
            </div>
            <div id="specialist-selection-screen" class="screen p-4">
                <header class="mb-5"><h1 class="text-xl font-bold">Выберите мастера</h1></header>
                <div id="specialist-selection-list" class="space-y-3"></div>
            </div>
            <div id="booking-screen" class="screen p-4">
                <header class="mb-5"><h1 class="text-xl font-bold">Выберите дату и время</h1></header>
                <div class="card p-4">
                    <h2 class="font-semibold mb-1 text-base" id="selected-service-title"></h2>
                    <p class="text-sm text-slate-500 mb-3" id="selected-specialist-subtitle" style="color: var(--hint-color);"></p>
                    <input type="date" id="date-picker" class="w-full p-2 border rounded-lg focus:ring-rose-400 focus:border-rose-400" style="background-color: var(--bg-color); color: var(--text-color);">
                </div>
                <div class="card p-4">
                    <h2 class="font-semibold mb-4">Доступное время:</h2>
                    <div id="time-slots-container" class="grid grid-cols-3 gap-3 text-center text-xs"></div>
                </div>
            </div>
            <div id="specialists-screen" class="screen p-4">
                <header class="mb-5"><h1 class="text-xl font-bold">Наши мастера</h1></header>
                <div id="specialists-list" class="space-y-4"></div>
            </div>
            <div id="my-appointments-screen" class="screen p-4">
                <header class="mb-5"><h1 class="text-xl font-bold">Мои записи</h1></header>
                <div id="appointments-list"></div>
            </div>
            <div id="profile-screen" class="screen p-4">
                <header class="mb-5"><h1 class="text-xl font-bold">Профиль</h1></header>
                <div class="card p-4 flex items-center">
                    <img id="profile-avatar" src="https://placehold.co/64x64/fde6ea/c08497?text=U" alt="Avatar" class="w-16 h-16 rounded-full mr-4">
                    <div>
                        <h2 id="profile-name" class="font-bold text-lg">Пользователь</h2>
                        <p id="profile-phone" class="text-slate-500" style="color: var(--hint-color);">Данные из Telegram</p>
                    </div>
                </div>
                <div class="card p-4">
                    <h3 class="font-semibold mb-3">Настройки</h3>
                    <div class="space-y-2">
                        <a href="#" class="flex justify-between items-center text-slate-600 hover:text-rose-500" style="color: var(--text-color);"><span>Уведомления</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></a>
                        <a href="#" class="flex justify-between items-center text-slate-600 hover:text-rose-500" style="color: var(--text-color);"><span>Привязанные карты</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></a>
                        <a href="#" class="flex justify-between items-center text-slate-600 hover:text-rose-500" style="color: var(--text-color);"><span>Помощь</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></a>
                    </div>
                </div>
            </div>
            <div id="success-screen" class="screen text-center p-8">
                <div class="mb-5">
                    <svg class="w-16 h-16 text-green-500 mx-auto" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                </div>
                <h1 class="text-xl font-bold mb-2">Вы успешно записаны!</h1>
                <p class="text-slate-600 mb-6" id="success-details" style="color: var(--hint-color);"></p>
                <button onclick="showScreen('my-appointments-screen')" class="btn-primary">Посмотреть мои записи</button>
            </div>
        </div>

        <nav id="navbar" class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)] flex justify-around p-2 z-10" style="background-color: var(--secondary-bg-color);">
            <button id="nav-home" class="nav-item flex flex-col items-center justify-center w-full text-xs p-1 rounded-lg">
                <svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                <span>Главная</span>
            </button>
            <button id="nav-services" class="nav-item flex flex-col items-center justify-center w-full text-xs p-1 rounded-lg">
                <svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                <span>Запись</span>
            </button>
            <button id="nav-specialists" class="nav-item flex flex-col items-center justify-center w-full text-xs p-1 rounded-lg">
                <svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <span>Мастера</span>
            </button>
            <button id="nav-appointments" class="nav-item flex flex-col items-center justify-center w-full text-xs p-1 rounded-lg">
                <svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                <span>Мои записи</span>
            </button>
            <button id="nav-profile" class="nav-item flex flex-col items-center justify-center w-full text-xs p-1 rounded-lg">
                <svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <span>Профиль</span>
            </button>
        </nav>
    </div>

    <div id="image-modal" class="modal fixed inset-0 bg-black bg-opacity-75 z-50 items-center justify-center p-4">
        <div class="relative">
            <img id="modal-img" src="" class="max-w-full max-h-[80vh] rounded-lg" alt="Portfolio Image">
            <button onclick="closeModal()" class="absolute -top-2 -right-2 bg-white rounded-full p-1 text-slate-700"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;

        const supabaseUrl = 'https://iwvglucrgnwetczrzwqk.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3dmdsdWNyZ253ZXRjenJ6d3FrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzY3NDgsImV4cCI6MjA3MDk1Mjc0OH0.Cn8YUKAlGyQKpZkXUxSHE9gQwsn0BFtH9GcaSJSpEiQ';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let specialists = [];
        let services = [];
        let portfolio = { stories: [], posts: [] };
        const availableTimeSlots = ['10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'];
        
        let salonConfig = { id: null, name: 'Beauty Haven', logo: '', initials: 'BH' };
        let bookingState = { service: null, specialist: null, date: null, time: null };
        let userAppointments = [];
        let screenHistory = ['home-screen'];
        let currentUser = { id: null, first_name: 'Пользователь' };

        const loader = document.getElementById('loader');
        const showLoader = () => loader.style.display = 'flex';
        const hideLoader = () => loader.style.display = 'none';

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeApp();
        });

        async function initializeApp() {
            showLoader();
            try {
                applyTheme();
                displayUserData();

                const hash = window.location.hash.substring(1);
                const urlParams = new URLSearchParams(hash);
                const salonId = urlParams.get('salonId');

                if (salonId) {
                    await loadSalonAndRunApp(salonId);
                } else {
                    runSetup();
                }
            } catch (e) {
                console.error("Initialization failed:", e);
                alert("Произошла критическая ошибка при запуске приложения.");
            } finally {
                hideLoader();
            }
        }

        async function loadSalonAndRunApp(salonId) {
            // *** ИСПРАВЛЕНИЕ: Добавлена проверка формата ID ***
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(salonId)) {
                 console.error('Invalid Salon ID format:', salonId);
                 alert('Некорректный формат ID салона в ссылке.');
                 runSetup();
                 return;
            }

            const { data, error } = await supabaseClient.from('salons').select('*').eq('id', salonId).single();
            
            // *** ИСПРАВЛЕНИЕ: Улучшенная обработка ошибок ***
            if (error || !data) {
                console.error('Supabase error fetching salon:', error);
                alert(`Не удалось загрузить данные салона. ID: ${salonId}. Ошибка: ${error ? error.message : 'Салон не найден'}`);
                runSetup();
                return;
            }

            salonConfig.id = data.id;
            salonConfig.name = data.name;
            salonConfig.logo = data.logo_url;
            salonConfig.initials = data.name.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
            
            await runMainApp();
        }

        function runSetup() {
            document.getElementById('setup-screen').classList.add('active', 'flex');
            document.getElementById('app-wrapper').style.display = 'none';
            document.getElementById('generate-link-btn').onclick = generateLink;
            document.getElementById('copy-link-btn').onclick = copyLink;
        }

        async function generateLink() {
            const nameInput = document.getElementById('salon-name-input').value.trim();
            const logoInput = document.getElementById('logo-url-input').value.trim();
            if (!nameInput || !logoInput) {
                tg.HapticFeedback.notificationOccurred('error');
                alert('Пожалуйста, заполните все поля');
                return;
            }
            showLoader();
            const { data, error } = await supabaseClient.from('salons').insert([{ name: nameInput, logo_url: logoInput }]).select().single();
            hideLoader();
            if (error) {
                console.error('Error creating salon:', error);
                alert('Не удалось создать салон. Попробуйте еще раз.');
                return;
            }
            const salonId = data.id;
            const baseUrl = window.location.href.split('#')[0].split('?')[0];
            const generatedUrl = `${baseUrl}#salonId=${salonId}`;
            document.getElementById('generated-link-input').value = generatedUrl;
            document.getElementById('link-result').style.display = 'block';
            tg.HapticFeedback.notificationOccurred('success');
        }

        function copyLink() {
            const linkInput = document.getElementById('generated-link-input');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                const feedback = document.getElementById('copy-feedback');
                feedback.style.display = 'block';
                tg.HapticFeedback.impactOccurred('light');
                setTimeout(() => { feedback.style.display = 'none'; }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                alert('Не удалось скопировать ссылку. Пожалуйста, скопируйте вручную.');
            }
        }

        async function runMainApp() {
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('app-wrapper').style.display = 'block';
            setupBranding();
            
            tg.ready();
            tg.expand();
            
            await upsertUser();
            
            setupEventListeners();
            
            await fetchData();

            renderAll();
            
            showScreen('home-screen');
            document.getElementById('nav-home').classList.add('active');
        }

        function setupBranding() {
            document.getElementById('salon-name-header').textContent = salonConfig.name;
            const logoContainer = document.getElementById('salon-logo-container');
            logoContainer.innerHTML = `<img src="${salonConfig.logo}" alt="Logo" class="w-10 h-10 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/40x40/c08497/ffffff?text=${salonConfig.initials}';">`;
            logoContainer.className = 'w-10 h-10 rounded-full';
            logoContainer.style.padding = '0';
            logoContainer.style.backgroundColor = 'transparent';
            logoContainer.style.opacity = '1';
        }

        function setupEventListeners() {
            document.getElementById('nav-home').onclick = () => showScreen('home-screen');
            document.getElementById('nav-services').onclick = () => showScreen('services-screen');
            document.getElementById('nav-specialists').onclick = () => showScreen('specialists-screen');
            document.getElementById('nav-appointments').onclick = () => showScreen('my-appointments-screen');
            document.getElementById('nav-profile').onclick = () => showScreen('profile-screen');
            document.getElementById('image-modal').onclick = (e) => { if(e.target.id === 'image-modal') closeModal(); };
            tg.MainButton.setText('Подтвердить запись');
            tg.MainButton.onClick(confirmBooking);
            tg.BackButton.onClick(goBack);
            setupDatePicker();
        }

        async function upsertUser() {
            if (!currentUser || !currentUser.id) return;
            const { error } = await supabaseClient
                .from('users')
                .upsert({
                    telegram_id: currentUser.id,
                    first_name: currentUser.first_name,
                    last_name: currentUser.last_name,
                    username: currentUser.username
                }, {
                    onConflict: 'telegram_id'
                });
            if (error) console.error('Error upserting user:', error);
        }

        async function fetchData() {
            const [servicesRes, specialistsRes, postsRes, storiesRes, appointmentsRes] = await Promise.all([
                supabaseClient.from('services').select('*').eq('salon_id', salonConfig.id),
                supabaseClient.from('specialists').select('*').eq('salon_id', salonConfig.id),
                supabaseClient.from('portfolio_posts').select('*, comments(*, users(first_name))').eq('salon_id', salonConfig.id),
                supabaseClient.from('portfolio_stories').select('*').eq('salon_id', salonConfig.id),
                supabaseClient.from('appointments').select('*, services(*), specialists(*)').eq('user_telegram_id', currentUser.id).eq('salon_id', salonConfig.id)
            ]);

            if (servicesRes.error) throw servicesRes.error;
            services = servicesRes.data;
            if (specialistsRes.error) throw specialistsRes.error;
            specialists = specialistsRes.data;
            if (postsRes.error) throw postsRes.error;
            portfolio.posts = postsRes.data;
            if (storiesRes.error) throw storiesRes.error;
            portfolio.stories = storiesRes.data;
            if (appointmentsRes.error) throw appointmentsRes.error;
            userAppointments = appointmentsRes.data.map(a => ({ ...a, service: a.services, specialist: a.specialists }));
        }
        
        function renderAll() {
            renderServices();
            renderAllSpecialists();
            renderAppointments();
            renderPortfolio();
        }

        function applyTheme() {
            const theme = tg.themeParams;
            const root = document.documentElement;
            root.style.setProperty('--bg-color', theme.bg_color || '#f8fafc');
            root.style.setProperty('--text-color', theme.text_color || '#334155');
            root.style.setProperty('--button-color', theme.button_color || '#c08497');
            root.style.setProperty('--button-text-color', theme.button_text_color || '#ffffff');
            root.style.setProperty('--hint-color', theme.hint_color || '#94a3b8');
            root.style.setProperty('--secondary-bg-color', theme.secondary_bg_color || '#ffffff');
            root.style.setProperty('--header-bg-color', theme.header_bg_color || theme.secondary_bg_color || '#ffffff');
        }

        function displayUserData() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                currentUser = tg.initDataUnsafe.user;
            } else {
                currentUser = { id: 123456789, first_name: 'Тест', last_name: 'Тестов', username: 'testuser' };
            }
            const userInitial = (currentUser.first_name || 'U').charAt(0);
            document.getElementById('profile-name').textContent = currentUser.first_name || 'Пользователь';
            document.getElementById('profile-avatar').src = `https://placehold.co/64x64/fde6ea/c08497?text=${userInitial}`;
        }

        function showScreen(screenId, isBack = false) {
            if (!isBack && screenHistory[screenHistory.length - 1] !== screenId) {
                screenHistory.push(screenId);
            }
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo(0, 0);
            const isHomeScreen = ['home-screen', 'services-screen', 'specialists-screen', 'my-appointments-screen', 'profile-screen'].includes(screenId);
            tg.BackButton.setVisible(!isHomeScreen);
            tg.MainButton.setVisible(screenId === 'booking-screen');
            if (screenId === 'booking-screen') updateConfirmButtonState();
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const navMapping = { 'home-screen': 'nav-home', 'post-view-screen': 'nav-home', 'services-screen': 'nav-services', 'booking-screen': 'nav-services', 'specialist-selection-screen': 'nav-services', 'specialists-screen': 'nav-specialists', 'my-appointments-screen': 'nav-appointments', 'profile-screen': 'nav-profile' };
            const activeNavId = navMapping[screenId];
            if (activeNavId) document.getElementById(activeNavId).classList.add('active');
        }

        function goBack() {
            tg.HapticFeedback.impactOccurred('light');
            if (screenHistory.length > 1) {
                screenHistory.pop();
                showScreen(screenHistory[screenHistory.length - 1], true);
            }
        }

        function renderPortfolio() {
            const postsContainer = document.getElementById('portfolio-posts');
            postsContainer.innerHTML = portfolio.posts.map(post => `
                <div class="card">
                    <div class="p-4 flex items-center">
                        <img src="${salonConfig.logo}" class="w-8 h-8 rounded-full mr-3 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/40x40/c08497/ffffff?text=${salonConfig.initials}';">
                        <span class="font-semibold">${salonConfig.name.toLowerCase().replace(/\s/g, '_')}</span>
                    </div>
                    <img src="${post.img_url}" alt="${post.title}" class="w-full h-auto cursor-pointer" onclick="openPostView(${post.id})">
                    <div class="p-4">
                        <div class="flex items-center space-x-4">
                             <button onclick="toggleLike(${post.id})" class="like-btn ${post.liked ? 'liked' : ''} flex items-center space-x-1 text-slate-600">
                                 <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                             </button>
                             <button onclick="openPostView(${post.id})" class="flex items-center space-x-1 text-slate-600">
                                 <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                             </button>
                        </div>
                        <p class="font-semibold mt-2">${post.likes} отметок "Нравится"</p>
                        <p class="mt-1"><span class="font-semibold">${salonConfig.name.toLowerCase().replace(/\s/g, '_')}</span> ${post.title}</p>
                        <a onclick="openPostView(${post.id})" class="text-xs text-slate-500 mt-1 inline-block" style="color: var(--hint-color);">Посмотреть комментарии (${post.comments.length})</a>
                    </div>
                </div>`).join('');
        }

        function renderServices() {
            document.getElementById('services-list').innerHTML = services.map(service => `
                <div class="card p-4 flex justify-between items-center">
                    <div>
                        <h2 class="font-semibold text-base">${service.name}</h2>
                        <p class="text-slate-500" style="color: var(--hint-color);">${service.duration} / ${service.price} ₽</p>
                    </div>
                    <button onclick='selectService(${JSON.stringify(service)})' class="btn-primary text-sm">Выбрать</button>
                </div>`).join('');
        }

        function renderAllSpecialists() {
            document.getElementById('specialists-list').innerHTML = specialists.map(specialist => `
                <div class="card p-4 flex items-center">
                    <img src="${specialist.photo_url}" alt="${specialist.name}" class="w-16 h-16 rounded-full mr-4 object-cover">
                    <div>
                        <h2 class="font-bold text-lg">${specialist.name}</h2>
                        <p class="text-slate-500" style="color: var(--hint-color);">${specialist.specialty}</p>
                    </div>
                </div>`).join('');
        }

        function renderSpecialistSelection(service) {
            const availableSpecialists = specialists.filter(s => service.specialist_ids.includes(s.id));
            document.getElementById('specialist-selection-list').innerHTML = availableSpecialists.map(specialist => `
                <div class="card p-4 flex justify-between items-center">
                    <div class="flex items-center">
                         <img src="${specialist.photo_url}" alt="${specialist.name}" class="w-12 h-12 rounded-full mr-4 object-cover">
                        <div>
                            <h2 class="font-semibold text-base">${specialist.name}</h2>
                            <p class="text-slate-500" style="color: var(--hint-color);">${specialist.specialty}</p>
                        </div>
                    </div>
                    <button onclick='selectSpecialistAndProceed(${JSON.stringify(specialist)}, ${JSON.stringify(service)})' class="btn-primary text-sm">Выбрать</button>
                </div>`).join('');
        }

        async function renderTimeSlots(date, specialistId) {
            const container = document.getElementById('time-slots-container');
            container.innerHTML = '';
            const { data: bookedSlots, error } = await supabaseClient.from('appointments').select('time').eq('date', date).eq('specialist_id', specialistId);
            if (error) { console.error("Error fetching booked slots:", error); return; }
            const bookedTimes = bookedSlots.map(s => s.time);
            availableTimeSlots.forEach(time => {
                const isDisabled = bookedTimes.includes(time);
                const slot = document.createElement('div');
                slot.textContent = time;
                slot.className = `time-slot p-2 rounded-lg ${isDisabled ? 'disabled' : ''}`;
                if (!isDisabled) slot.onclick = () => selectTime(time);
                container.appendChild(slot);
            });
        }

        function renderAppointments() {
            const container = document.getElementById('appointments-list');
            if (userAppointments.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-500 mt-10" style="color: var(--hint-color);"><p>У вас пока нет записей.</p><button onclick="showScreen('services-screen')" class="btn-primary mt-4">Записаться</button></div>`;
                return;
            }
            container.innerHTML = userAppointments.map(appt => {
                   const formattedDate = new Date(appt.date).toLocaleDateString('ru-RU', { weekday: 'long', month: 'long', day: 'numeric' });
                   return `
                        <div class="card p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-base">${appt.service.name}</p>
                                    <p class="text-slate-500" style="color: var(--hint-color);">Мастер: ${appt.specialist.name}</p>
                                    <p class="font-semibold mt-2" style="color: var(--button-color);">${formattedDate} в ${appt.time}</p>
                                </div>
                                <button onclick="cancelAppointment(${appt.id})" class="text-xs text-red-500 bg-red-50 px-2 py-1 rounded-md">Отменить</button>
                            </div>
                        </div>`
            }).join('');
        }

        function openPostView(postId) {
            const post = portfolio.posts.find(p => p.id === postId);
            if (!post) return;
            const container = document.getElementById('post-view-screen');
            let commentsHtml = post.comments.map(comment => `
                <div class="flex items-start space-x-3">
                    <img src="https://placehold.co/32x32/e0e7ff/4338ca?text=${(comment.users.first_name || 'U').charAt(0)}" class="w-8 h-8 rounded-full flex-shrink-0">
                    <div>
                        <div class="bg-slate-100 rounded-xl p-3" style="background-color: var(--bg-color);">
                            <p class="font-semibold text-xs">${comment.users.first_name}</p>
                            <p class="text-sm">${comment.text}</p>
                        </div>
                    </div>
                </div>`).join('');
            if (post.comments.length === 0) {
                commentsHtml = `<p class="text-slate-400 text-center text-xs py-4" style="color: var(--hint-color);">Комментариев пока нет.</p>`;
            }
            container.innerHTML = `
                <header class="flex items-center p-4 bg-white shadow-sm flex-shrink-0" style="background-color: var(--header-bg-color);"><h1 class="text-lg font-bold">Публикация</h1></header>
                <div class="flex-grow overflow-y-auto">
                    <div class="bg-white" style="background-color: var(--secondary-bg-color);">
                        <img src="${post.img_url}" alt="${post.title}" class="w-full h-auto">
                        <div class="p-4"><p class="font-semibold mt-2" id="like-count-${post.id}">${post.likes} отметок "Нравится"</p></div>
                    </div>
                    <div class="p-4 space-y-4" id="comments-section-${post.id}">${commentsHtml}</div>
                </div>
                <div class="mt-auto p-2 bg-white border-t border-slate-200 flex items-center space-x-2 flex-shrink-0" style="background-color: var(--secondary-bg-color);">
                    <img src="https://placehold.co/32x32/fde6ea/c08497?text=${currentUser.first_name.charAt(0)}" class="w-8 h-8 rounded-full">
                    <input id="comment-input-${post.id}" type="text" placeholder="Добавить комментарий..." class="w-full bg-slate-100 rounded-full py-2 px-4 focus:outline-none" style="background-color: var(--bg-color);">
                    <button onclick="addComment(${post.id})" class="font-semibold" style="color: var(--button-color);">Post</button>
                </div>`;
            showScreen('post-view-screen');
        }

        async function toggleLike(postId) {
            tg.HapticFeedback.impactOccurred('light');
            const post = portfolio.posts.find(p => p.id === postId);
            if (!post) return;
            const newLikes = post.liked ? post.likes - 1 : post.likes + 1;
            post.liked = !post.liked;
            post.likes = newLikes;
            const { error } = await supabaseClient.from('portfolio_posts').update({ likes: newLikes }).eq('id', postId);
            if (error) console.error("Error updating likes:", error);
            renderPortfolio();
        }
        
        async function addComment(postId) {
            const post = portfolio.posts.find(p => p.id === postId);
            const input = document.getElementById(`comment-input-${postId}`);
            const text = input.value.trim();
            if (!post || !text) return;
            const newComment = { post_id: postId, user_telegram_id: currentUser.id, text: text };
            const { data, error } = await supabaseClient.from('comments').insert(newComment).select('*, users(first_name)').single();
            if (error) { console.error("Error adding comment:", error); return; }
            post.comments.push(data);
            input.value = '';
            openPostView(postId);
        }

        function openModal(imgSrc) {
            document.getElementById('modal-img').src = imgSrc;
            document.getElementById('image-modal').classList.add('show');
        }
        function closeModal() {
            document.getElementById('image-modal').classList.remove('show');
        }

        function selectService(service) {
            tg.HapticFeedback.impactOccurred('light');
            bookingState.service = service;
            renderSpecialistSelection(service);
            showScreen('specialist-selection-screen');
        }

        function selectSpecialistAndProceed(specialist, service) {
            tg.HapticFeedback.impactOccurred('light');
            bookingState.specialist = specialist;
            bookingState.service = service;
            document.getElementById('selected-service-title').textContent = service.name;
            document.getElementById('selected-specialist-subtitle').textContent = `Мастер: ${specialist.name}`;
            showScreen('booking-screen');
            document.getElementById('date-picker').dispatchEvent(new Event('change'));
        }

        function setupDatePicker() {
            const datePicker = document.getElementById('date-picker');
            const today = new Date();
            datePicker.min = today.toISOString().split('T')[0];
            datePicker.value = today.toISOString().split('T')[0];
            datePicker.addEventListener('change', (event) => {
                bookingState.date = event.target.value;
                bookingState.time = null;
                if (bookingState.specialist) renderTimeSlots(bookingState.date, bookingState.specialist.id);
                updateConfirmButtonState();
            });
        }

        function selectTime(time) {
            tg.HapticFeedback.selectionChanged();
            document.querySelectorAll('#time-slots-container .time-slot').forEach(slot => {
                slot.classList.remove('selected');
                if (slot.textContent === time) slot.classList.add('selected');
            });
            bookingState.time = time;
            updateConfirmButtonState();
        }
        
        function updateConfirmButtonState() {
            const canConfirm = bookingState.service && bookingState.specialist && bookingState.date && bookingState.time;
            tg.MainButton.setParams({ is_active: canConfirm, is_visible: true });
        }

        async function confirmBooking() {
            if (!tg.MainButton.isActive) return;
            showLoader();
            const appointmentData = {
                salon_id: salonConfig.id,
                user_telegram_id: currentUser.id,
                service_id: bookingState.service.id,
                specialist_id: bookingState.specialist.id,
                date: bookingState.date,
                time: bookingState.time
            };
            const { data, error } = await supabaseClient.from('appointments').insert(appointmentData).select('*, services(*), specialists(*)').single();
            hideLoader();
            if (error) {
                console.error("Error confirming booking:", error);
                alert("Не удалось создать запись. Пожалуйста, попробуйте еще раз.");
                return;
            }
            const newAppointment = { ...data, service: data.services, specialist: data.specialists };
            userAppointments.push(newAppointment);
            userAppointments.sort((a,b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
            const successDetails = document.getElementById('success-details');
            const formattedDate = new Date(bookingState.date).toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            successDetails.textContent = `Мы ждем вас ${formattedDate} в ${bookingState.time} на услугу "${bookingState.service.name}" к мастеру ${bookingState.specialist.name}.`;
            showScreen('success-screen');
            renderAppointments();
            bookingState = { service: null, specialist: null, date: null, time: null };
            document.getElementById('date-picker').value = new Date().toISOString().split('T')[0];
            tg.HapticFeedback.notificationOccurred('success');
        }

        async function cancelAppointment(appointmentId) {
            showLoader();
            const { error } = await supabaseClient.from('appointments').delete().eq('id', appointmentId);
            hideLoader();
            if (error) {
                console.error("Error canceling appointment:", error);
                alert("Не удалось отменить запись.");
                return;
            }
            userAppointments = userAppointments.filter(a => a.id !== appointmentId);
            renderAppointments();
            tg.HapticFeedback.notificationOccurred('warning');
        }
    </script>
</body>
</html>
