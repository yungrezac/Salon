<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Конструктор Салона Красоты</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc;
            --text-color: #334155;
            --button-color: #c08497;
            --button-text-color: #ffffff;
            --hint-color: #94a3b8;
            --secondary-bg-color: #ffffff;
            --header-bg-color: #ffffff;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .main-container { padding-bottom: 80px; }
        .btn-primary, .admin-btn { background-color: var(--button-color); color: var(--button-text-color); font-weight: 600; border-radius: 0.75rem; padding: 0.65rem 1.5rem; transition: background-color: 0.3s; }
        .btn-primary:hover, .admin-btn:hover { opacity: 0.9; }
        .card { background-color: var(--secondary-bg-color); border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07); margin-bottom: 1rem; }
        .screen { display: none; }
        .screen.active { display: block; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--button-color); animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .admin-input { @apply w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500; }
        .admin-card { @apply bg-white p-6 rounded-lg shadow-md mb-6; }
    </style>
</head>
<body class="antialiased text-sm">

    <div id="loader"><div class="spinner"></div></div>

    <!-- ========= КЛИЕНТСКАЯ ЧАСТЬ И КОНСТРУКТОР ========= -->
    <div id="client-mode-wrapper">
        <!-- Экран создания салона (Конструктор) -->
        <div id="setup-screen" class="screen p-6 min-h-screen flex-col justify-center items-center">
            <div class="w-full max-w-md text-center">
                <h1 class="text-2xl font-bold mb-2">Создайте свой салон</h1>
                <p class="text-slate-500 mb-8">Заполните данные, чтобы получить ссылки на приложение и панель управления.</p>
                <div class="card p-6 text-left !mb-6">
                    <div class="mb-4">
                        <label class="block font-semibold mb-2">Название салона</label>
                        <input type="text" id="salon-name-input" placeholder="Например, Beauty Haven" class="w-full p-3 border rounded-lg">
                    </div>
                    <div class="mb-4">
                        <label class="block font-semibold mb-2">URL логотипа</label>
                        <input type="url" id="logo-url-input" placeholder="https://example.com/logo.png" class="w-full p-3 border rounded-lg">
                    </div>
                    <div class="mb-6">
                        <label class="block font-semibold mb-2">Придумайте пароль для админ-панели</label>
                        <input type="password" id="salon-admin-password" placeholder="••••••••" class="w-full p-3 border rounded-lg">
                    </div>
                    <button id="generate-link-btn" class="btn-primary w-full py-3">Создать салон</button>
                </div>
                <div id="link-result" class="text-left" style="display: none;">
                     <div class="card p-4 space-y-4">
                        <div>
                            <label class="block font-semibold mb-2 text-sm">Ссылка для ваших клиентов:</label>
                            <div class="flex space-x-2">
                                <input type="text" id="generated-client-link" readonly class="w-full p-2 border rounded-lg bg-slate-100 text-xs">
                                <button onclick="copyLink('generated-client-link')" class="btn-primary text-sm px-4">Копировать</button>
                            </div>
                        </div>
                        <div>
                            <label class="block font-semibold mb-2 text-sm text-red-600">Ваша секретная ссылка для админ-панели:</label>
                            <div class="flex space-x-2">
                                <input type="text" id="generated-admin-link" readonly class="w-full p-2 border rounded-lg bg-slate-100 text-xs">
                                <button onclick="copyLink('generated-admin-link')" class="btn-primary text-sm px-4">Копировать</button>
                            </div>
                        </div>
                        <p id="copy-feedback" class="text-green-600 text-xs mt-2 text-center" style="display: none;">Скопировано!</p>
                     </div>
                </div>
            </div>
        </div>

        <!-- Обертка для клиентского приложения -->
        <div id="app-wrapper" style="display: none;">
            <!-- Здесь все экраны клиентского приложения (home, services, profile и т.д.) -->
            <!-- ... -->
        </div>
    </div>

    <!-- ========= АДМИН-ПАНЕЛЬ ========= -->
    <div id="admin-mode-wrapper" style="display: none;" class="p-4 md:p-8">
        <!-- Экран входа по паролю -->
        <div id="login-screen" class="max-w-md mx-auto">
            <div class="admin-card">
                <h1 class="text-2xl font-bold mb-4">Вход в панель управления</h1>
                <p class="mb-4 text-gray-600">Введите пароль от вашего салона.</p>
                <input type="password" id="password-input" class="admin-input" placeholder="••••••••">
                <button id="login-btn" class="admin-btn w-full mt-4 bg-indigo-600 hover:bg-indigo-700">Войти</button>
                <p id="login-error" class="text-red-500 mt-2 text-sm text-center"></p>
            </div>
        </div>

        <!-- Основная админ-панель (скрыта по умолчанию) -->
        <div id="admin-panel" style="display: none;">
            <h1 class="text-3xl font-bold mb-6">Панель управления салоном "<span id="admin-salon-name"></span>"</h1>
            <!-- Настройки внешнего вида -->
            <div class="admin-card">
                <h2 class="text-xl font-semibold mb-4">Настройки внешнего вида</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="block text-sm font-medium">Кнопки</label><input type="color" id="theme-button-color" class="w-full h-10"></div>
                    <div><label class="block text-sm font-medium">Текст на кнопках</label><input type="color" id="theme-button-text-color" class="w-full h-10"></div>
                    <div><label class="block text-sm font-medium">Фон</label><input type="color" id="theme-bg-color" class="w-full h-10"></div>
                    <div><label class="block text-sm font-medium">Текст</label><input type="color" id="theme-text-color" class="w-full h-10"></div>
                </div>
                <button id="save-theme-btn" class="admin-btn mt-4 bg-indigo-600 hover:bg-indigo-700">Сохранить тему</button>
            </div>
            <!-- Управление услугами -->
            <div class="admin-card">
                <h2 class="text-xl font-semibold mb-4">Услуги</h2>
                <div id="admin-services-list" class="space-y-2 mb-4"></div>
                <h3 class="font-semibold mb-2">Добавить услугу</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input id="new-service-name" placeholder="Название" class="admin-input">
                    <input id="new-service-price" placeholder="Цена (число)" type="number" class="admin-input">
                    <input id="new-service-duration" placeholder="Длительность" class="admin-input">
                </div>
                <button id="add-service-btn" class="admin-btn mt-4 bg-indigo-600 hover:bg-indigo-700">Добавить</button>
            </div>
            <!-- Управление мастерами -->
            <!-- ... -->
        </div>
    </div>

    <script>
        // ==================================================================
        // ОБЩАЯ ЧАСТЬ: ИНИЦИАЛИЗАЦИЯ И УТИЛИТЫ
        // ==================================================================
        const tg = window.Telegram.WebApp;
        const supabaseUrl = 'https://iwvglucrgnwetczrzwqk.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3dmdsdWNyZ253ZXRjenJ6d3FrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzY3NDgsImV4cCI6MjA3MDk1Mjc0OH0.Cn8YUKAlGyQKpZkXUxSHE9gQwsn0BFtH9GcaSJSpEiQ';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let salonId = null;
        let salonConfig = {};
        let currentUser = {};
        let services = [], specialists = [], portfolio = { posts: [] };

        const loader = document.getElementById('loader');
        const showLoader = () => loader.style.display = 'flex';
        const hideLoader = () => loader.style.display = 'none';

        document.addEventListener('DOMContentLoaded', initializeRouter);

        async function initializeRouter() {
            showLoader();
            try {
                const params = await getUrlParams();
                salonId = params.get('salonId');
                const mode = params.get('mode');

                if (mode === 'admin') {
                    document.getElementById('client-mode-wrapper').style.display = 'none';
                    document.getElementById('admin-mode-wrapper').style.display = 'block';
                    await initializeAdminPanel();
                } else {
                    document.getElementById('admin-mode-wrapper').style.display = 'none';
                    document.getElementById('client-mode-wrapper').style.display = 'block';
                    await initializeClientApp();
                }
            } catch (e) {
                console.error("Initialization failed:", e);
                alert("Произошла критическая ошибка при запуске приложения.");
            } finally {
                hideLoader();
            }
        }

        function getUrlParams() {
            return new Promise(resolve => {
                let attempts = 0;
                const interval = setInterval(() => {
                    const hash = window.location.hash.substring(1);
                    if (hash || attempts > 20) {
                        clearInterval(interval);
                        resolve(new URLSearchParams(hash));
                    }
                    attempts++;
                }, 100);
            });
        }

        function applyTheme(theme) {
            const root = document.documentElement;
            if (!theme) return;
            root.style.setProperty('--bg-color', theme.bg_color || '#f8fafc');
            root.style.setProperty('--text-color', theme.text_color || '#334155');
            root.style.setProperty('--button-color', theme.button_color || '#c08497');
            root.style.setProperty('--button-text-color', theme.button_text_color || '#ffffff');
            root.style.setProperty('--secondary-bg-color', theme.secondary_bg_color || '#ffffff');
        }

        // ==================================================================
        // ЧАСТЬ 1: КОНСТРУКТОР И КЛИЕНТСКОЕ ПРИЛОЖЕНИЕ
        // ==================================================================
        
        async function initializeClientApp() {
            applyTheme({}); // Сброс на дефолтную тему
            displayUserData();
            
            if (salonId) {
                await loadSalonAndRunApp(salonId);
            } else {
                runSetup();
            }
        }

        function runSetup() {
            document.getElementById('setup-screen').classList.add('active', 'flex');
            document.getElementById('app-wrapper').style.display = 'none';
            document.getElementById('generate-link-btn').onclick = generateLink;
        }

        async function generateLink() {
            const name = document.getElementById('salon-name-input').value.trim();
            const logo = document.getElementById('logo-url-input').value.trim();
            const password = document.getElementById('salon-admin-password').value.trim();

            if (!name || !logo || !password) {
                alert('Пожалуйста, заполните все поля.');
                return;
            }
            
            showLoader();
            // 1. Создаем салон
            const { data: salonData, error: salonError } = await supabaseClient
                .from('salons')
                .insert([{ name, logo_url: logo, admin_password: password }])
                .select()
                .single();

            if (salonError) {
                hideLoader();
                alert('Ошибка создания салона: ' + salonError.message);
                return;
            }

            // 2. Создаем для него тему по умолчанию
            await supabaseClient.from('themes').insert([{ salon_id: salonData.id }]);
            hideLoader();

            const newSalonId = salonData.id;
            const baseUrl = window.location.href.split('#')[0];
            document.getElementById('generated-client-link').value = `${baseUrl}#salonId=${newSalonId}`;
            document.getElementById('generated-admin-link').value = `${baseUrl}#salonId=${newSalonId}&mode=admin`;
            document.getElementById('link-result').style.display = 'block';
        }
        
        function copyLink(elementId) {
            const linkInput = document.getElementById(elementId);
            linkInput.select();
            document.execCommand('copy');
            const feedback = document.getElementById('copy-feedback');
            feedback.style.display = 'block';
            setTimeout(() => { feedback.style.display = 'none'; }, 2000);
        }

        async function loadSalonAndRunApp(id) {
            const { data, error } = await supabaseClient.from('salons').select(`*, themes(*)`).eq('id', id).single();
            if (error || !data) {
                alert(`Не удалось загрузить данные салона: ${error ? error.message : 'Салон не найден'}`);
                runSetup();
                return;
            }
            salonConfig = data;
            if (data.themes && data.themes.length > 0) applyTheme(data.themes[0]);
            await runMainClientApp();
        }

        async function runMainClientApp() {
            // Здесь должна быть вся логика клиентского приложения
            // Для краткости, я оставлю только каркас.
            // Вставьте сюда HTML-код экранов из предыдущей версии внутрь #app-wrapper
            // и JS-функции для их работы (fetchData, renderAll, и т.д.)
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('app-wrapper').style.display = 'block';
            // ... остальная логика клиента
            alert(`Клиентское приложение для "${salonConfig.name}" запущено!`);
        }

        function displayUserData() {
             if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                currentUser = tg.initDataUnsafe.user;
            } else {
                currentUser = { id: 123456789, first_name: 'Тест' };
            }
        }

        // ==================================================================
        // ЧАСТЬ 2: АДМИН-ПАНЕЛЬ
        // ==================================================================

        async function initializeAdminPanel() {
            if (!salonId) {
                document.body.innerHTML = '<h1 class="text-center text-2xl font-bold mt-10">Ошибка: ID салона не найден в ссылке для входа в админ-панель.</h1>';
                return;
            }
            document.getElementById('login-btn').onclick = handleLogin;
        }

        async function handleLogin() {
            showLoader();
            const passwordInput = document.getElementById('password-input').value;
            const loginError = document.getElementById('login-error');
            loginError.textContent = '';

            const { data, error } = await supabaseClient.from('salons').select('admin_password').eq('id', salonId).single();

            if (error || !data) {
                loginError.textContent = 'Не удалось проверить пароль. Салон не найден.';
                hideLoader();
                return;
            }

            if (data.admin_password === passwordInput) {
                await showAdminPanel();
            } else {
                loginError.textContent = 'Неверный пароль.';
            }
            hideLoader();
        }

        async function showAdminPanel() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            
            showLoader();
            await loadAdminData();
            renderAdminPanel();
            hideLoader();

            document.getElementById('save-theme-btn').onclick = saveTheme;
            document.getElementById('add-service-btn').onclick = addService;
        }

        async function loadAdminData() {
            const { data, error } = await supabaseClient.from('salons').select(`*, themes(*), services(*)`).eq('id', salonId).single();
            if (error) {
                alert('Не удалось загрузить данные админ-панели.');
                return;
            }
            salonConfig = data;
        }

        function renderAdminPanel() {
            document.getElementById('admin-salon-name').textContent = salonConfig.name;
            const theme = salonConfig.themes[0] || {};
            document.getElementById('theme-button-color').value = theme.button_color || '#c08497';
            document.getElementById('theme-button-text-color').value = theme.button_text_color || '#ffffff';
            document.getElementById('theme-bg-color').value = theme.bg_color || '#f8fafc';
            document.getElementById('theme-text-color').value = theme.text_color || '#334155';
            renderAdminServices();
        }

        function renderAdminServices() {
            const container = document.getElementById('admin-services-list');
            container.innerHTML = (salonConfig.services || []).map(service => `
                <div class="flex justify-between items-center p-2 border rounded-md">
                    <span>${service.name} - ${service.price} ₽</span>
                    <button onclick="deleteService(${service.id})" class="text-red-500 hover:text-red-700 font-bold">X</button>
                </div>
            `).join('');
        }

        async function saveTheme() {
            showLoader();
            const themeData = {
                salon_id: salonId,
                button_color: document.getElementById('theme-button-color').value,
                button_text_color: document.getElementById('theme-button-text-color').value,
                bg_color: document.getElementById('theme-bg-color').value,
                text_color: document.getElementById('theme-text-color').value,
            };
            const { error } = await supabaseClient.from('themes').upsert(themeData, { onConflict: 'salon_id' });
            hideLoader();
            if (error) alert('Ошибка сохранения темы: ' + error.message);
            else alert('Тема успешно сохранена!');
        }

        async function addService() {
            const name = document.getElementById('new-service-name').value;
            const price = document.getElementById('new-service-price').value;
            const duration = document.getElementById('new-service-duration').value;
            if (!name || !price || !duration) {
                alert('Заполните все поля для новой услуги.');
                return;
            }
            showLoader();
            const { data, error } = await supabaseClient.from('services').insert([{ salon_id: salonId, name, price, duration, specialist_ids: [] }]).select().single();
            if (error) {
                alert('Ошибка добавления услуги: ' + error.message);
            } else {
                salonConfig.services.push(data);
                renderAdminServices();
                document.getElementById('new-service-name').value = '';
                document.getElementById('new-service-price').value = '';
                document.getElementById('new-service-duration').value = '';
            }
            hideLoader();
        }

        async function deleteService(serviceId) {
            if (!confirm('Вы уверены?')) return;
            showLoader();
            const { error } = await supabaseClient.from('services').delete().eq('id', serviceId);
            if (error) {
                alert('Ошибка удаления: ' + error.message);
            } else {
                salonConfig.services = salonConfig.services.filter(s => s.id !== serviceId);
                renderAdminServices();
            }
            hideLoader();
        }
    </script>
</body>
</html>
